<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8">
  <title>Tickets √úbersicht</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@1/css/pico.min.css">
  <style>
    body{max-width:1350px;background:#0a0a0a;color:#00ff00}
    h1{display:flex;align-items:center;gap:.6rem;margin-bottom:.2rem;color:#00ff00}
    .sub{font-size:.75rem;opacity:.75;margin:0 0 1.25rem;color:#00cc00}
    a.back{display:inline-flex;align-items:center;gap:.35rem;margin-bottom:1.4rem;text-decoration:none;color:#00ff00}
    a.back:hover{color:#00cc00}
    .controls{display:flex;flex-direction:column;gap:.9rem;margin-bottom:.9rem}
    .controls .row{display:flex;flex-wrap:wrap;gap:.55rem;align-items:center}
    #search{flex:1 1 520px;min-width:280px;background:#1a1a1a;border:1px solid #00ff00;color:#00ff00}
    label.inline{display:flex;align-items:center;gap:.4rem;font-size:.72rem;white-space:nowrap;color:#00ff00}
    .chipbar{display:flex;flex-wrap:wrap;gap:.5rem}
    .chip{background:#1a1a1a;border:1px solid #00ff00;color:#00ff00;padding:.46rem 1.05rem;border-radius:999px;font-size:.7rem;font-weight:500;cursor:pointer;line-height:1;user-select:none;transition:.15s}
    .chip:hover{background:#002200}
    .chip.active{background:#00ff00;color:#000;box-shadow:0 0 8px #00ff00}
    .chip.prio span{display:inline-block;width:.9rem;height:.9rem;border-radius:50%;}
    .chip.prio span.green{background:#2bd94a}
    .chip.prio span.orange{background:#ff9900}
    .chip.prio span.red{background:#d92b2b}
    #refreshBar{background:#1a1a1a;color:#00ff00;border:1px solid #00ff00;border-radius:8px;padding:.85rem 1.1rem;display:flex;align-items:center;justify-content:space-between;margin-top:.4rem}
    #refreshBar button{background:#002200;border:1px solid #00ff00;color:#00ff00;padding:.55rem 1.1rem;border-radius:6px;cursor:pointer;font-size:.75rem;display:flex;align-items:center;gap:.45rem}
    #refreshBar button:hover{background:#003300}
    table{width:100%;font-size:.8rem;border-collapse:collapse;background:#0a0a0a}
    thead th{white-space:nowrap;cursor:pointer;user-select:none;padding:.55rem .6rem;font-size:.7rem;letter-spacing:.5px;text-transform:uppercase;background:#1a1a1a;color:#00ff00;border:1px solid #00ff00}
    thead th.sortAsc:after{content:" \25B2"}
    thead th.sortDesc:after{content:" \25BC"}
    tbody td{padding:.55rem .6rem;vertical-align:middle;border:1px solid #003300;color:#00cc00}
    tbody tr:hover{background:#001100}
    .badge{background:#1a1a1a;color:#00ff00;border:1px solid #00ff00;font-family:monospace;font-size:.65rem;padding:.2rem .45rem;border-radius:.4rem;display:inline-block}
    .status-offen{color:#00ff00;font-weight:600}
    .status-geschlossen{color:#ff0000;font-weight:600}
    .prio-dot{font-size:1rem}
    .nowrap{white-space:nowrap}
    .trans-link{text-decoration:none;color:#00ff00}
    .trans-link:hover{color:#00cc00}
    .details-btn{cursor:pointer;color:#00ff00;text-decoration:none}
    .details-btn:hover{color:#00cc00}
    .form-data{font-size:.7rem;padding:.3rem;background:#1a1a1a;border:1px solid #00ff00;border-radius:4px;margin-top:.3rem;display:none;color:#00cc00}
    .form-data.show{display:block}
    .form-data dt{font-weight:bold;color:#00ff00;margin-top:.3rem}
    .form-data dd{margin-left:1rem;color:#00cc00}
    tr.hide{display:none}
    footer{margin:2.2rem 0 .8rem;font-size:.65rem;opacity:.65;color:#00cc00}
    code{background:#1a1a1a;color:#00ff00;border:1px solid #00ff00;padding:.1rem .3rem;border-radius:3px}
    a{color:#00ff00}
    a:hover{color:#00cc00}
    @media (max-width:880px){ thead th:nth-child(8), tbody td:nth-child(8){display:none} }
    @media (max-width:680px){ thead th:nth-child(7), tbody td:nth-child(7){display:none} }
  </style>
</head>
<body class="container">
  <h1>üé´ Tickets √úbersicht</h1>
  <p class="sub">Nur f√ºr Team-Mitglieder sichtbar. Live-Daten aus <code>tickets.json</code>.</p>
  <a href="/panel" class="back">‚¨ÖÔ∏è Zur√ºck zum Panel</a>

  <!-- Diese Variablen werden VOM Server (panel.js /tickets) gesetzt -->
  <script>
    window.__TICKETS = <%- tickets %>;
    window.__MEMBERS = <%- memberMap %>;
    window.GUILD_ID  = '<%= guildId %>';
  </script>

  <section class="controls">
    <div class="row">
      <input id="search" placeholder="Suche (ID, Topic, User, Claimer)" autocomplete="off">
      <label class="inline"><input type="checkbox" id="auto" checked> Auto-Refresh (30s)</label>
    </div>
    <div class="row chipbar" id="statusBar">
      <button class="chip active" data-status="alle">Alle</button>
      <button class="chip" data-status="offen">Offen</button>
      <button class="chip" data-status="geschlossen">Geschlossen</button>
      <button class="chip" data-claim="alle">Claimed+Unclaimed</button>
      <button class="chip" data-claim="claimed">Claimed</button>
      <button class="chip" data-claim="unclaimed">Unclaimed</button>
      <button class="chip active" data-prio="alle" id="prioAll">Prio: Alle</button>
      <button class="chip prio" data-prio="0" title="Gr√ºn"><span class="green"></span></button>
      <button class="chip prio" data-prio="1" title="Orange"><span class="orange"></span></button>
      <button class="chip prio" data-prio="2" title="Rot"><span class="red"></span></button>
    </div>
    <div id="refreshBar"><button id="refreshBtn">üîÑ Aktualisieren</button><span id="lastUpdate" style="font-size:.7rem;opacity:.75">Letztes Update: ‚Äì</span></div>
  </section>

  <table id="ticketsTable">
    <thead>
      <tr>
        <th data-sort="id">#</th>
        <th data-sort="priority">Prio</th>
        <th data-sort="status">Status</th>
        <th data-sort="topic">Topic</th>
        <th data-sort="userName">User</th>
        <th data-sort="claimerName">Claimer</th>
        <th data-sort="timestamp">Erstellt</th>
        <th>Details</th>
        <th data-sort="channelId">Kanal</th>
        <th>Transcript</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <footer>Ticket-Verlauf ‚Ä¢ Client-seitige Filter & Sortierung ‚Ä¢ Letztes Update: <span id="footerUpdate">‚Äì</span></footer>

<script>
  // Erwartet: server setzt window.__TICKETS, window.__MEMBERS und window.GUILD_ID
</script>
<script>
  const ticketsRaw = window.__TICKETS || [];
  const memberMap = window.__MEMBERS || {}; // { id: { display, tag, nickname, username } }
  const GUILD_ID = window.GUILD_ID || '';

  let tickets = ticketsRaw.slice();
  let sortKey = 'id';
  let sortDir = 'desc';
  let statusFilter = 'alle';
  let claimFilter = 'alle';
  let prioFilter = 'alle';

  const tbody = document.querySelector('#ticketsTable tbody');
  const dots = ['üü¢','üü†','üî¥'];

  function displayName(id){
    if(!id) return '';
    const m = memberMap[id];
    if(!m) return id;
    return m.display || m.nickname || m.username || m.tag || id;
  }
  function fmt(ts){ const d=new Date(ts); return d.toLocaleDateString('de-DE',{day:'numeric',month:'numeric',year:'numeric'})+', '+d.toLocaleTimeString('de-DE',{hour:'2-digit',minute:'2-digit',second:'2-digit'}); }

  function apply(){
    let list = tickets.slice();
    if(statusFilter!=='alle') list = list.filter(t=>t.status===statusFilter);
    if(claimFilter==='claimed') list = list.filter(t=>!!t.claimer);
    if(claimFilter==='unclaimed') list = list.filter(t=>!t.claimer);
    if(prioFilter!=='alle') list = list.filter(t=>(t.priority||0)==+prioFilter);
    const q = document.getElementById('search').value.trim().toLowerCase();
    if(q) list = list.filter(t=> (
      String(t.id).includes(q) ||
      (t.topic||'').toLowerCase().includes(q) ||
      (t.userId||'').includes(q) ||
      (t.claimer||'').includes(q) ||
      displayName(t.userId).toLowerCase().includes(q) ||
      displayName(t.claimer).toLowerCase().includes(q)
    ));

    list.sort((a,b)=>{
      let av, bv;
      if(sortKey==='userName'){ av = displayName(a.userId).toLowerCase(); bv = displayName(b.userId).toLowerCase(); }
      else if(sortKey==='claimerName'){ av = displayName(a.claimer).toLowerCase(); bv = displayName(b.claimer).toLowerCase(); }
      else { av = a[sortKey]; bv = b[sortKey]; }
      if(['id','timestamp','priority'].includes(sortKey)){ av=Number(av)||0; bv=Number(bv)||0; }
      else { av=(av||'').toString().toLowerCase(); bv=(bv||'').toString().toLowerCase(); }
      if(av<bv) return sortDir==='asc'? -1:1;
      if(av>bv) return sortDir==='asc'? 1:-1;
      return 0;
    });
    render(list);
  }

  function render(list){
    tbody.innerHTML = list.map(t=>{
      const pr = t.priority||0;
      const userName = displayName(t.userId);
      const claimerName = displayName(t.claimer);
      const hasFormData = t.formData && Object.keys(t.formData).length > 0;
      let formDataHtml = '';
      if(hasFormData){
        const entries = Object.entries(t.formData).map(([k,v])=>`<dt>${esc(k)}:</dt><dd>${esc(v||'‚Äî')}</dd>`).join('');
        formDataHtml = `<dl class="form-data" id="fd-${t.id}">${entries}</dl>`;
      }
      return `<tr data-status="${t.status}" data-claimed="${t.claimer? 'yes':'no'}" data-prio="${pr}">
        <td class="nowrap"><span class="badge">${t.id}</span></td>
        <td class="prio-dot">${dots[pr]}</td>
        <td class="status-${t.status}">${t.status}</td>
        <td>${t.topic||''}</td>
        <td><span class="badge" title="${t.userId||''}">${userName}</span></td>
        <td>${t.claimer? `<span class="badge" title="${t.claimer}">${claimerName}</span>`:''}</td>
        <td class="nowrap">${fmt(t.timestamp)}</td>
        <td>${hasFormData? `<span class="details-btn" onclick="toggleFormData(${t.id})">üìã</span>${formDataHtml}`:''}</td>
        <td><a href="https://discord.com/channels/${GUILD_ID}/${t.channelId}" target="_blank" title="Channel √∂ffnen">üîó</a></td>
        <td><a class="trans-link" href="/transcript/${t.id}" target="_blank" title="Transcript √∂ffnen">üìÑ</a></td>
      </tr>`;
    }).join('');
  }

  function toggleFormData(id){
    const el = document.getElementById('fd-'+id);
    if(el) el.classList.toggle('show');
  }
  function esc(s){return String(s).replace(/</g,'&lt;').replace(/>/g,'&gt;');}

  document.querySelectorAll('#ticketsTable thead th[data-sort]').forEach(th=>{
    th.addEventListener('click', ()=>{
      const k = th.dataset.sort;
      if(sortKey===k) sortDir = (sortDir==='asc'?'desc':'asc'); else { sortKey=k; sortDir='asc'; }
      document.querySelectorAll('#ticketsTable thead th').forEach(h=>h.classList.remove('sortAsc','sortDesc'));
      th.classList.add(sortDir==='asc'?'sortAsc':'sortDesc');
      apply();
    });
  });

  const statusBar = document.getElementById('statusBar');
  statusBar.addEventListener('click', e=>{
    const btn = e.target.closest('.chip'); if(!btn) return;
    if(btn.dataset.status){ statusFilter = btn.dataset.status; toggleActive('status', statusFilter); }
    if(btn.dataset.claim){ claimFilter = btn.dataset.claim; toggleActive('claim', claimFilter); }
    if(btn.dataset.prio){ prioFilter = btn.dataset.prio; toggleActive('prio', prioFilter); }
    apply();
  });
  function toggleActive(type, val){
    document.querySelectorAll(`.chip[data-${type}]`).forEach(c=>{ c.classList.toggle('active', c.getAttribute(`data-${type}`)===val); });
    if(type==='prio' && val!=='alle') document.getElementById('prioAll').classList.remove('active');
  }

  document.getElementById('search').addEventListener('input', apply);
  document.getElementById('refreshBtn').addEventListener('click', reloadData);

  function setTimes(){ const ts=new Date().toLocaleString('de-DE'); document.getElementById('lastUpdate').textContent='Letztes Update: '+ts; document.getElementById('footerUpdate').textContent=ts; }
  setTimes();
  setInterval(()=>{ if(document.getElementById('auto').checked) reloadData(); }, 30000);

  async function reloadData(){
    try { const r = await fetch('/tickets/data?_=' + Date.now()); if(!r.ok) return; tickets = await r.json(); setTimes(); apply(); } catch{}
  }

  apply();
</script>
</body>
</html>
