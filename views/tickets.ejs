<!doctype html>
<html lang="de" data-theme="light">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0">
  <title>Tickets Ãœbersicht</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@1/css/pico.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  <link rel="stylesheet" href="/markdown.css">
  <style>
    :root {
      --bg-color: #fff;
      --text-color: #1a1a1a;
      --border-color: #e5e8ec;
      --accent-color: #00b894;
      --accent-hover: #00a077;
      --table-hover: #f6f8fb;
      --thead-bg: #f2f4f8;
      --chip-bg: #eef0f5;
      --chip-active: #4263eb;
      --refresh-bar-bg: #13202b;
    }

    [data-theme="dark"] {
      --bg-color: #0a0a0a;
      --text-color: #00ff88;
      --border-color: #1a3a2a;
      --accent-color: #00ff88;
      --accent-hover: #00dd77;
      --table-hover: #0f1f15;
      --thead-bg: #0f1f15;
      --chip-bg: #0f1f15;
      --chip-active: #00ff88;
      --refresh-bar-bg: #0a1a0f;
    }

    [data-theme="dark"] body {
      background-color: var(--bg-color);
      color: var(--text-color);
    }

    [data-theme="dark"] tbody tr:hover {
      background: var(--table-hover);
    }

    [data-theme="dark"] thead {
      background: var(--thead-bg);
    }

    [data-theme="dark"] .chip {
      background: var(--chip-bg);
      color: var(--text-color);
    }

    [data-theme="dark"] .chip.active {
      background: var(--chip-active);
      color: #000;
    }

    [data-theme="dark"] #refreshBar {
      background: var(--refresh-bar-bg);
      color: var(--text-color);
    }

    [data-theme="dark"] #refreshBar button {
      background: var(--chip-bg);
      color: var(--text-color);
    }

    [data-theme="dark"] input {
      background: var(--chip-bg);
      border-color: var(--border-color);
      color: var(--text-color);
    }

    [data-theme="dark"] .badge {
      background: var(--chip-bg);
      color: var(--text-color);
    }

    [data-theme="dark"] a {
      color: var(--accent-color);
    }

    [data-theme="dark"] .form-data {
      background: var(--chip-bg);
      border-color: var(--border-color);
      color: var(--text-color);
    }

    [data-theme="dark"] tbody td {
      border-top-color: var(--border-color);
    }

    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
    }

    body {
      display: flex;
      flex-direction: column;
      min-height: 100vh;
      width: 100%;
      max-width: 100%;
      padding: 0 2rem;
      line-height: 1.8;
      margin: 0;
    }

    /* Mobile Responsive */
    @media (max-width: 768px) {
      body {
        padding: 0 1rem;
      }

      h1 { font-size: 1.5rem; }

      .controls .row {
        flex-direction: column !important;
        gap: 0.5rem !important;
      }

      #search {
        flex: 1 1 auto !important;
        min-width: 100% !important;
      }

      .chipbar {
        flex-wrap: wrap;
        justify-content: flex-start;
      }

      .chip {
        font-size: 0.65rem !important;
        padding: 0.4rem 0.8rem !important;
      }

      #refreshBar {
        flex-direction: column !important;
        gap: 0.5rem;
        padding: 0.7rem !important;
      }

      #refreshBar button {
        width: 100%;
      }

      /* Table Responsive */
      table {
        font-size: 0.75rem;
        overflow-x: auto;
        display: block;
      }

      thead th {
        padding: 0.6rem 0.5rem !important;
        font-size: 0.7rem !important;
      }

      tbody td {
        padding: 0.6rem 0.5rem !important;
      }

      /* Hide less important columns on mobile */
      thead th:nth-child(9), tbody td:nth-child(9),
      thead th:nth-child(8), tbody td:nth-child(8),
      thead th:nth-child(6), tbody td:nth-child(6) {
        display: none;
      }

      .badge {
        font-size: 0.6rem !important;
        padding: 0.15rem 0.35rem !important;
      }

      .theme-toggle {
        top: 0.5rem !important;
        right: 0.5rem !important;
        width: 2.5rem !important;
        height: 2.5rem !important;
        font-size: 1.2rem !important;
      }

      .back {
        font-size: 0.9rem !important;
      }

      label.inline {
        font-size: 0.7rem !important;
      }
    }

    /* Tablet Responsive */
    @media (min-width: 769px) and (max-width: 1024px) {
      body {
        padding: 0 2rem;
      }

      table {
        font-size: 0.75rem;
      }

      /* Hide one column on tablet */
      thead th:nth-child(9), tbody td:nth-child(9) {
        display: none;
      }
    }

    main {
      flex: 1;
    }
    h1{display:flex;align-items:center;gap:.8rem;margin-bottom:.5rem;margin-top:2rem}
    .sub{font-size:.85rem;opacity:.7;margin:0 0 2rem}
    a.back{display:inline-flex;align-items:center;gap:.35rem;margin-bottom:1.4rem;text-decoration:none}
    .controls{display:flex;flex-direction:column;gap:.9rem;margin-bottom:.9rem}
    .controls .row{display:flex;flex-wrap:wrap;gap:.55rem;align-items:center}
    #search{flex:1 1 520px;min-width:280px}
    label.inline{display:flex;align-items:center;gap:.4rem;font-size:.72rem;white-space:nowrap}
    .chipbar{display:flex;flex-wrap:wrap;gap:.5rem}
    .chip{background:#eef0f5;border:0;padding:.46rem 1.05rem;border-radius:999px;font-size:.7rem;font-weight:500;cursor:pointer;line-height:1;user-select:none;transition:.15s}
    .chip.active{background:#4263eb;color:#fff;box-shadow:0 0 0 1px #4263eb}
    .chip.prio span{display:inline-block;width:.9rem;height:.9rem;border-radius:50%;}
    .chip.prio span.green{background:#2bd94a}
    .chip.prio span.orange{background:#ff9900}
    .chip.prio span.red{background:#d92b2b}
    #refreshBar{background:#13202b;color:#fff;border-radius:8px;padding:.85rem 1.1rem;display:flex;align-items:center;justify-content:space-between;margin-top:.4rem}
    #refreshBar button{background:#1e2d3a;border:0;color:#fff;padding:.55rem 1.1rem;border-radius:6px;cursor:pointer;font-size:.75rem;display:flex;align-items:center;gap:.45rem}
    table{width:100%;font-size:.8rem;border-collapse:collapse}
    thead th{white-space:nowrap;cursor:pointer;user-select:none;padding:.8rem 1rem;font-size:.75rem;letter-spacing:.5px;text-transform:uppercase}
    thead th.sortAsc:after{content:" \25B2"}
    thead th.sortDesc:after{content:" \25BC"}
    tbody td{padding:.8rem 1rem;vertical-align:middle;border-top:1px solid #e5e8ec}
    tbody tr:hover{background:#f6f8fb}
    .badge{background:#e3e7ec;font-family:monospace;font-size:.65rem;padding:.2rem .45rem;border-radius:.4rem;display:inline-block}
    .status-offen{color:#2bd94a;font-weight:600}
    .status-geschlossen{color:#d92b2b;font-weight:600}
    .prio-dot{font-size:1rem}
    .nowrap{white-space:nowrap}
    .trans-link{text-decoration:none}
    .details-btn{cursor:pointer;text-decoration:none}
    .form-data{font-size:.7rem;padding:.3rem;background:#f0f0f0;border:1px solid #ddd;border-radius:4px;margin-top:.3rem;display:none}
    .form-data.show{display:block}
    .form-data dt{font-weight:bold;margin-top:.3rem}
    .form-data dd{margin-left:1rem}
    tr.hide{display:none}
    footer{margin:2.2rem 0 .8rem;margin-bottom: 3rem; padding-bottom: 2rem; font-size:.65rem;opacity:.55}

    [data-theme="dark"] footer {
      margin-bottom: 4rem;
      padding-bottom: 3rem;
    }
    @media (max-width:880px){ thead th:nth-child(9), tbody td:nth-child(9){display:none} }
    @media (max-width:680px){ thead th:nth-child(8), tbody td:nth-child(8){display:none} }

    .theme-toggle {
      position: fixed;
      top: 1.5rem;
      right: 1.5rem;
      background: var(--accent-color);
      color: #000;
      border: 0;
      width: 3rem;
      height: 3rem;
      border-radius: 50%;
      cursor: pointer;
      font-size: 1.5rem;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s;
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
      z-index: 1000;
    }

    .theme-toggle:hover {
      transform: scale(1.1);
      background: var(--accent-hover);
    }

    [data-theme="dark"] .theme-toggle {
      background: var(--accent-color);
      box-shadow: 0 2px 12px rgba(0,255,136,0.4);
    }

    .nav-buttons {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 2rem;
      flex-wrap: wrap;
    }

    .nav-buttons a {
      padding: 0.6rem 1.2rem;
      background: var(--accent-color);
      color: #000;
      text-decoration: none;
      border-radius: 6px;
      font-size: 0.9rem;
      font-weight: 600;
      transition: all 0.2s;
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      border: 2px solid transparent;
    }

    .nav-buttons a:hover {
      background: var(--accent-hover);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,184,148,0.3);
    }

    [data-theme="dark"] .nav-buttons a {
      background: var(--accent-color);
      color: #000;
    }

    [data-theme="dark"] .nav-buttons a:hover {
      background: var(--accent-hover);
      box-shadow: 0 4px 12px rgba(0,255,136,0.4);
    }

    .nav-buttons a.secondary-btn {
      background: transparent;
      border-color: var(--accent-color);
      color: var(--accent-color);
    }

    .nav-buttons a.secondary-btn:hover {
      background: var(--accent-color);
      color: #000;
    }

    @media (max-width: 768px) {
      .nav-buttons {
        flex-direction: column;
      }

      .nav-buttons a {
        width: 100%;
        justify-content: center;
      }
    }
  </style>
</head>
<body>
  <button class="theme-toggle" onclick="toggleTheme()" title="Dark Mode umschalten">
    <i id="themeIcon" class="fas fa-moon"></i>
  </button>
  <h1><i class="fas fa-ticket-alt"></i> Tickets Ãœbersicht</h1>
  <p class="sub">Nur fÃ¼r Team-Mitglieder sichtbar. Live-Daten aus <code>tickets.json</code>.</p>

  <div class="nav-buttons">
    <a href="/panel">
      <i class="fas fa-arrow-left"></i> <%= lang === 'de' ? 'ZurÃ¼ck zum Panel' : lang === 'en' ? 'Back to Panel' : lang === 'he' ? '×—×–×¨×” ×œ×¤×× ×œ' : lang === 'ja' ? 'ãƒ‘ãƒãƒ«ã«æˆ»ã‚‹' : lang === 'ru' ? 'ÐÐ°Ð·Ð°Ð´ Ðº Ð¿Ð°Ð½ÐµÐ»Ð¸' : lang === 'pt' ? 'Voltar ao Painel' : lang === 'es' ? 'Volver al Panel' : lang === 'id' ? 'Kembali ke Panel' : 'ZurÃ¼ck zum Panel' %>
    </a>
    <a href="/" class="secondary-btn">
      <i class="fas fa-home"></i> <%= lang === 'de' ? 'Zur Startseite' : lang === 'en' ? 'Back to Home' : lang === 'he' ? '×—×–×¨×” ×œ×“×£ ×”×‘×™×ª' : lang === 'ja' ? 'ãƒ›ãƒ¼ãƒ ã«æˆ»ã‚‹' : lang === 'ru' ? 'ÐÐ° Ð³Ð»Ð°Ð²Ð½ÑƒÑŽ' : lang === 'pt' ? 'Voltar ao InÃ­cio' : lang === 'es' ? 'Volver al Inicio' : lang === 'id' ? 'Kembali ke Beranda' : 'Zur Startseite' %>
    </a>
    <a href="/select-server" class="secondary-btn">
      <i class="fas fa-server"></i> <%= lang === 'de' ? 'Server wechseln' : lang === 'en' ? 'Change Server' : lang === 'he' ? '×”×—×œ×£ ×©×¨×ª' : lang === 'ja' ? 'ã‚µãƒ¼ãƒãƒ¼ã‚’å¤‰æ›´' : lang === 'ru' ? 'Ð¡Ð¼ÐµÐ½Ð¸Ñ‚ÑŒ ÑÐµÑ€Ð²ÐµÑ€' : lang === 'pt' ? 'Trocar Servidor' : lang === 'es' ? 'Cambiar Servidor' : lang === 'id' ? 'Ganti Server' : 'Server wechseln' %>
    </a>
  </div>

  <!-- Diese Variablen werden VOM Server (panel.js /tickets) gesetzt -->
  <script>
    window.__TICKETS = <%- tickets %>;
    window.__MEMBERS = <%- memberMap %>;
    window.GUILD_ID  = '<%= guildId %>';
  </script>

  <section class="controls">
    <div class="row">
      <input id="search" placeholder="Suche (ID, Topic, User, Claimer)" autocomplete="off">
      <label class="inline"><input type="checkbox" id="auto" checked> Auto-Refresh (30s)</label>
    </div>
    <div class="row chipbar" id="statusBar">
      <button class="chip active" data-status="alle">Alle</button>
      <button class="chip" data-status="offen">Offen</button>
      <button class="chip" data-status="geschlossen">Geschlossen</button>
      <button class="chip" data-claim="alle">Claimed+Unclaimed</button>
      <button class="chip" data-claim="claimed">Claimed</button>
      <button class="chip" data-claim="unclaimed">Unclaimed</button>
      <button class="chip active" data-prio="alle" id="prioAll">Prio: Alle</button>
      <button class="chip prio" data-prio="0" title="GrÃ¼n"><span class="green"></span></button>
      <button class="chip prio" data-prio="1" title="Orange"><span class="orange"></span></button>
      <button class="chip prio" data-prio="2" title="Rot"><span class="red"></span></button>
    </div>
    <div id="refreshBar"><button id="refreshBtn">ðŸ”„ Aktualisieren</button><span id="lastUpdate" style="font-size:.7rem;opacity:.75">Letztes Update: â€“</span></div>
  </section>

  <table id="ticketsTable">
    <thead>
      <tr>
        <th data-sort="id">#</th>
        <th data-sort="priority">Prio</th>
        <th data-sort="status">Status</th>
        <th data-sort="topic">Topic</th>
        <th data-sort="userName">User</th>
        <th data-sort="claimerName">Claimer</th>
        <th data-sort="timestamp">Erstellt</th>
        <th>Details</th>
        <th data-sort="channelId">Kanal</th>
        <th>Transcript</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <footer>
    <p>TRS Tickets Â© 2025 Theredstonee â€¢ Alle Rechte vorbehalten â€¢ Version <%= version %></p>
    <p style="margin-top: 0.3rem;">Letztes Update: <span id="footerUpdate">â€“</span></p>
  </footer>

<script>
  // Erwartet: server setzt window.__TICKETS, window.__MEMBERS und window.GUILD_ID
</script>
<script>
  const ticketsRaw = window.__TICKETS || [];
  const memberMap = window.__MEMBERS || {}; // { id: { display, tag, nickname, username } }
  const GUILD_ID = window.GUILD_ID || '';

  let tickets = ticketsRaw.slice();
  let sortKey = 'id';
  let sortDir = 'desc';
  let statusFilter = 'alle';
  let claimFilter = 'alle';
  let prioFilter = 'alle';

  const tbody = document.querySelector('#ticketsTable tbody');
  const dots = ['ðŸŸ¢','ðŸŸ ','ðŸ”´'];

  function displayName(id){
    if(!id) return '';
    const m = memberMap[id];
    if(!m) return id;
    return m.display || m.nickname || m.username || m.tag || id;
  }
  function fmt(ts){ const d=new Date(ts); return d.toLocaleDateString('de-DE',{day:'numeric',month:'numeric',year:'numeric'})+', '+d.toLocaleTimeString('de-DE',{hour:'2-digit',minute:'2-digit',second:'2-digit'}); }

  function apply(){
    let list = tickets.slice();
    if(statusFilter!=='alle') list = list.filter(t=>t.status===statusFilter);
    if(claimFilter==='claimed') list = list.filter(t=>!!t.claimer);
    if(claimFilter==='unclaimed') list = list.filter(t=>!t.claimer);
    if(prioFilter!=='alle') list = list.filter(t=>(t.priority||0)==+prioFilter);
    const q = document.getElementById('search').value.trim().toLowerCase();
    if(q) list = list.filter(t=> (
      String(t.id).includes(q) ||
      (t.topic||'').toLowerCase().includes(q) ||
      (t.userId||'').includes(q) ||
      (t.claimer||'').includes(q) ||
      displayName(t.userId).toLowerCase().includes(q) ||
      displayName(t.claimer).toLowerCase().includes(q)
    ));

    list.sort((a,b)=>{
      let av, bv;
      if(sortKey==='userName'){ av = displayName(a.userId).toLowerCase(); bv = displayName(b.userId).toLowerCase(); }
      else if(sortKey==='claimerName'){ av = displayName(a.claimer).toLowerCase(); bv = displayName(b.claimer).toLowerCase(); }
      else { av = a[sortKey]; bv = b[sortKey]; }
      if(['id','timestamp','priority'].includes(sortKey)){ av=Number(av)||0; bv=Number(bv)||0; }
      else { av=(av||'').toString().toLowerCase(); bv=(bv||'').toString().toLowerCase(); }
      if(av<bv) return sortDir==='asc'? -1:1;
      if(av>bv) return sortDir==='asc'? 1:-1;
      return 0;
    });
    render(list);
  }

  function render(list){
    tbody.innerHTML = list.map(t=>{
      const pr = t.priority||0;
      const userName = displayName(t.userId);
      const claimerName = displayName(t.claimer);
      const hasFormData = t.formData && Object.keys(t.formData).length > 0;
      let formDataHtml = '';
      if(hasFormData){
        const entries = Object.entries(t.formData).map(([k,v])=>`<dt>${esc(k)}:</dt><dd>${esc(v||'â€”')}</dd>`).join('');
        formDataHtml = `<dl class="form-data" id="fd-${t.id}">${entries}</dl>`;
      }
      return `<tr data-status="${t.status}" data-claimed="${t.claimer? 'yes':'no'}" data-prio="${pr}">
        <td class="nowrap"><span class="badge">${t.id}</span></td>
        <td class="prio-dot">${dots[pr]}</td>
        <td class="status-${t.status}">${t.status}</td>
        <td>${t.topic||''}</td>
        <td><span class="badge" title="${t.userId||''}">${userName}</span></td>
        <td>${t.claimer? `<span class="badge" title="${t.claimer}">${claimerName}</span>`:''}</td>
        <td class="nowrap">${fmt(t.timestamp)}</td>
        <td>${hasFormData? `<span class="details-btn" onclick="toggleFormData(${t.id})">ðŸ“‹</span>${formDataHtml}`:''}</td>
        <td><a href="https://discord.com/channels/${GUILD_ID}/${t.channelId}" target="_blank" title="Channel Ã¶ffnen">ðŸ”—</a></td>
        <td><a class="trans-link" href="/transcript/${t.id}" target="_blank" title="Transcript Ã¶ffnen">ðŸ“„</a></td>
      </tr>`;
    }).join('');
  }

  function toggleFormData(id){
    const el = document.getElementById('fd-'+id);
    if(el) el.classList.toggle('show');
  }
  function esc(s){return String(s).replace(/</g,'&lt;').replace(/>/g,'&gt;');}

  document.querySelectorAll('#ticketsTable thead th[data-sort]').forEach(th=>{
    th.addEventListener('click', ()=>{
      const k = th.dataset.sort;
      if(sortKey===k) sortDir = (sortDir==='asc'?'desc':'asc'); else { sortKey=k; sortDir='asc'; }
      document.querySelectorAll('#ticketsTable thead th').forEach(h=>h.classList.remove('sortAsc','sortDesc'));
      th.classList.add(sortDir==='asc'?'sortAsc':'sortDesc');
      apply();
    });
  });

  const statusBar = document.getElementById('statusBar');
  statusBar.addEventListener('click', e=>{
    const btn = e.target.closest('.chip'); if(!btn) return;
    if(btn.dataset.status){ statusFilter = btn.dataset.status; toggleActive('status', statusFilter); }
    if(btn.dataset.claim){ claimFilter = btn.dataset.claim; toggleActive('claim', claimFilter); }
    if(btn.dataset.prio){ prioFilter = btn.dataset.prio; toggleActive('prio', prioFilter); }
    apply();
  });
  function toggleActive(type, val){
    document.querySelectorAll(`.chip[data-${type}]`).forEach(c=>{ c.classList.toggle('active', c.getAttribute(`data-${type}`)===val); });
    if(type==='prio' && val!=='alle') document.getElementById('prioAll').classList.remove('active');
  }

  document.getElementById('search').addEventListener('input', apply);
  document.getElementById('refreshBtn').addEventListener('click', reloadData);

  function setTimes(){ const ts=new Date().toLocaleString('de-DE'); document.getElementById('lastUpdate').textContent='Letztes Update: '+ts; document.getElementById('footerUpdate').textContent=ts; }
  setTimes();
  setInterval(()=>{ if(document.getElementById('auto').checked) reloadData(); }, 30000);

  async function reloadData(){
    try { const r = await fetch('/tickets/data?_=' + Date.now()); if(!r.ok) return; tickets = await r.json(); setTimes(); apply(); } catch{}
  }

  apply();

  // Theme Toggle
  function toggleTheme() {
    const html = document.documentElement;
    const currentTheme = html.getAttribute('data-theme');
    const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
    html.setAttribute('data-theme', newTheme);
    localStorage.setItem('trs-theme', newTheme);
    document.getElementById('themeIcon').className = newTheme === 'dark' ? 'fas fa-sun' : 'fas fa-moon';
  }

  // Theme beim Laden setzen
  (function() {
    const savedTheme = localStorage.getItem('trs-theme') || 'light';
    document.documentElement.setAttribute('data-theme', savedTheme);
    document.getElementById('themeIcon').className = savedTheme === 'dark' ? 'fas fa-sun' : 'fas fa-moon';
  })();
</script>
</body>
</html>
