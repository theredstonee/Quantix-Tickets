<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8">
  <title>Tickets Ãœbersicht</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@1/css/pico.min.css">
  <style>
    body { max-width: 1400px; }
    table { width:100%; font-size:.8rem; }
    th, td { vertical-align: middle; }
    th { user-select:none; cursor:pointer; }
    .status-offen { color:#2bd94a; font-weight:600; }
    .status-geschlossen { color:#d92b2b; font-weight:600; }
    .status-claimed { color:#ffa500; font-weight:600; }
    .prio-dot { font-size:1rem; }
    .toolbar { display:flex; gap:1rem; flex-wrap:wrap; align-items:center; margin-bottom:1rem; }
    .toolbar > * { flex: 0 0 auto; }
    .chips { display:flex; gap:.4rem; flex-wrap:wrap; }
    .chip { padding:.25rem .6rem; border-radius:999px; background:#eee; font-size:.7rem; cursor:pointer; }
    .chip.active { background:#5865F2; color:#fff; }
    .badge { padding:.15rem .45rem; border-radius:.4rem; font-size:.65rem; background:#444; color:#fff; }
    .prio-0 { color:#2bd94a; }
    .prio-1 { color:#ff9900; }
    .prio-2 { color:#d92b2b; }
    .claimed { background:#ffb347; color:#000; }
    .unclaimed { background:#888; }
    .nowrap { white-space:nowrap; }
    .small { font-size:.65rem; opacity:.7; }
    .claim-cell { font-size:.65rem; }
    .hidden { display:none !important; }
    .refresh-btn { margin-left:auto; }
  </style>
</head>
<body class="container">
  <header>
    <h1>ğŸ« Tickets Ãœbersicht</h1>
    <p class="small">Nur fÃ¼r Team-Mitglieder sichtbar. Live-Daten aus <code>tickets.json</code> (Reload / Auto-Refresh).</p>
    <nav><a href="/panel">â¬…ï¸ ZurÃ¼ck zum Panel</a></nav>
  </header>

  <div class="toolbar">
    <input type="text" id="search" placeholder="Suche (ID, Topic, User, Claimer)" style="min-width:260px;">
    <div class="chips" id="statusFilter">
      <span class="chip active" data-status="alle">Alle</span>
      <span class="chip" data-status="offen">Offen</span>
      <span class="chip" data-status="geschlossen">Geschlossen</span>
      <span class="chip" data-status="claimed">Claimed</span>
      <span class="chip" data-status="unclaimed">Unclaimed</span>
    </div>
    <div class="chips" id="prioFilter">
      <span class="chip active" data-prio="all">Prio: Alle</span>
      <span class="chip" data-prio="0">ğŸŸ¢</span>
      <span class="chip" data-prio="1">ğŸŸ </span>
      <span class="chip" data-prio="2">ğŸ”´</span>
    </div>
    <label style="display:flex;align-items:center;gap:.3rem;font-size:.7rem;">
      <input type="checkbox" id="autoRefresh" checked> Autoâ€‘Refresh (30s)
    </label>
    <button id="reload" class="contrast refresh-btn">ğŸ”„ Aktualisieren</button>
  </div>

  <table id="ticketsTable">
    <thead>
      <tr>
        <th data-sort="id">#</th>
        <th data-sort="priority">Prio</th>
        <th data-sort="status">Status</th>
        <th data-sort="topic">Topic</th>
        <th data-sort="userId">User</th>
        <th data-sort="claimer">Claimer</th>
        <th data-sort="timestamp">Erstellt</th>
        <th>Kanal</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <footer style="margin-top:2rem;font-size:.65rem;opacity:.6">
    Ticket-Verlauf â€¢ Filtering & Sorting client-seitig â€¢ Letztes Update: <span id="lastUpdate">â€“</span>
  </footer>

<script>
const tbody = document.querySelector('#ticketsTable tbody');
let allTickets = [];
let currentSort = { key: 'id', dir: 'desc' };

async function loadTickets(){
  const res = await fetch('/tickets.json?_=' + Date.now()).catch(()=>null);
  if(!res || !res.ok){ return; }
  allTickets = await res.json();
  render();
  document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString('de-DE');
}

function sortTickets(list){
  const { key, dir } = currentSort;
  return list.sort((a,b)=>{
    let va=a[key], vb=b[key];
    if(key === 'timestamp'){ va=+va; vb=+vb; }
    if(key === 'priority'){ va=+(va||0); vb=+(vb||0); }
    if(key === 'id'){ va=+va; vb=+vb; }
    if(va==null) va=''; if(vb==null) vb='';
    if(typeof va === 'string') va=va.toLowerCase();
    if(typeof vb === 'string') vb=vb.toLowerCase();
    if(va<vb) return dir==='asc'? -1:1;
    if(va>vb) return dir==='asc'? 1:-1;
    return 0;
  });
}

function activeStatus(){ return document.querySelector('#statusFilter .chip.active').dataset.status; }
function activePrio(){ return document.querySelector('#prioFilter .chip.active').dataset.prio; }

function render(){
  const q = document.getElementById('search').value.trim().toLowerCase();
  const st = activeStatus();
  const pf = activePrio();
  const filtered = allTickets.filter(t=>{
    if(st==='offen' && t.status!=='offen') return false;
    if(st==='geschlossen' && t.status!=='geschlossen') return false;
    if(st==='claimed' && !t.claimer) return false;
    if(st==='unclaimed' && t.claimer) return false;
    if(pf!=='all' && String(t.priority||0)!==pf) return false;
    const hay=(t.id+ ' ' + (t.topic||'') + ' ' + (t.userId||'') + ' ' + (t.claimer||'')).toLowerCase();
    if(q && !hay.includes(q)) return false;
    return true;
  });
  const sorted = sortTickets(filtered.slice());
  tbody.innerHTML = sorted.map(t=>{
    const prio = t.priority||0;
    const dots=['ğŸŸ¢','ğŸŸ ','ğŸ”´'];
    const statusClass = 'status-' + t.status;
    return `<tr>
      <td class="nowrap">#${t.id}</td>
      <td class="prio-dot prio-${prio}">${dots[prio]}</td>
      <td class="${statusClass}">${t.status}${t.claimer?'<span class="badge claimed" title="Claimed">C</span>':''}</td>
      <td>${t.topic||''}</td>
      <td><code>${t.userId||''}</code></td>
      <td class="claim-cell">${t.claimer?'<code>'+t.claimer+'</code>':'<span class="badge unclaimed">â€”</span>'}</td>
      <td class="nowrap">${new Date(t.timestamp).toLocaleString('de-DE')}</td>
      <td><a href="https://discord.com/channels/${t.guildId||''}/${t.channelId}" target="_blank">ğŸ”—</a></td>
    </tr>`; }).join('');
}

// Sorting Events
Array.from(document.querySelectorAll('th[data-sort]')).forEach(th=>{
  th.addEventListener('click',()=>{
    const key = th.dataset.sort;
    if(currentSort.key===key){ currentSort.dir = currentSort.dir==='asc'?'desc':'asc'; }
    else { currentSort.key=key; currentSort.dir='asc'; }
    render();
  });
});

// Filter Chips
function chipGroup(id, attr){
  document.getElementById(id).addEventListener('click', e=>{
    if(!e.target.classList.contains('chip')) return;
    [...e.currentTarget.children].forEach(c=>c.classList.remove('active'));
    e.target.classList.add('active');
    render();
  });
}
chipGroup('statusFilter','status');
chipGroup('prioFilter','prio');

// Suche
search.addEventListener('input',()=>render());

// Reload
reload.addEventListener('click',()=>loadTickets());

// Auto Refresh
setInterval(()=>{ if(document.getElementById('autoRefresh').checked) loadTickets(); }, 30000);

loadTickets();
</script>
</body>
</html>
