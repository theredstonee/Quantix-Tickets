<!doctype html>
<html lang="de" data-theme="light">
<head>
  <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-SLMX16ZJ6Y"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'G-SLMX16ZJ6Y');
  </script>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0">
  <title>Tickets Ãœbersicht</title>
  <!-- Favicon -->
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon.png">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/favicon.png">
  <link rel="shortcut icon" href="/images/favicon.png">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@1/css/pico.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  <link rel="stylesheet" href="/markdown.css">
  <style>
    :root {
      --bg-color: #f0f8ff;
      --text-color: #1a1a2e;
      --border-color: #bdd7ee;
      --accent-color: #0ea5e9;
      --accent-hover: #0284c7;
      --table-hover: #e0f2fe;
      --thead-bg: #dbeafe;
      --chip-bg: #e0f2fe;
      --chip-active: #0ea5e9;
      --refresh-bar-bg: #1e3a8a;
      --glass-bg: rgba(240, 248, 255, 0.7);
      --glass-border: rgba(14, 165, 233, 0.3);
      --shadow-color: rgba(14, 165, 233, 0.15);
      --card-bg: rgba(255, 255, 255, 0.9);
    }

    [data-theme="dark"] {
      --bg-color: #0a0a0a;
      --text-color: #00ff88;
      --border-color: #1a3a2a;
      --accent-color: #00ff88;
      --accent-hover: #00dd77;
      --table-hover: #0f1f15;
      --thead-bg: #0f1f15;
      --chip-bg: #0f1f15;
      --chip-active: #00ff88;
      --refresh-bar-bg: #0a1a0f;
      --glass-bg: rgba(15, 21, 16, 0.7);
      --glass-border: rgba(0, 255, 136, 0.3);
      --shadow-color: rgba(0, 255, 136, 0.2);
      --card-bg: rgba(15, 21, 16, 0.9);
    }

    [data-theme="dark"] body {
      background-color: var(--bg-color);
      color: var(--text-color);
    }

    [data-theme="dark"] tbody tr:hover {
      background: var(--table-hover);
    }

    [data-theme="dark"] thead {
      background: var(--thead-bg);
    }

    [data-theme="dark"] .chip {
      background: var(--chip-bg);
      color: var(--text-color);
    }

    [data-theme="dark"] .chip.active {
      background: var(--chip-active);
      color: #000;
    }

    [data-theme="dark"] #refreshBar {
      background: var(--refresh-bar-bg);
      color: var(--text-color);
    }

    [data-theme="dark"] #refreshBar button {
      background: var(--chip-bg);
      color: var(--text-color);
    }

    [data-theme="dark"] input {
      background: var(--chip-bg);
      border-color: var(--border-color);
      color: var(--text-color);
    }

    [data-theme="dark"] .badge {
      background: var(--chip-bg);
      color: var(--text-color);
    }

    [data-theme="dark"] a {
      color: var(--accent-color);
    }

    [data-theme="dark"] .form-data {
      background: var(--chip-bg);
      border-color: var(--border-color);
      color: var(--text-color);
    }

    [data-theme="dark"] tbody td {
      border-top-color: var(--border-color);
    }

    /* Animated Background */
    body::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: -1;
      background: radial-gradient(circle, var(--accent-color) 1px, transparent 1px);
      background-size: 50px 50px;
      opacity: 0.03;
      animation: bgMove 20s linear infinite;
    }

    @keyframes bgMove {
      0% { transform: translate(0, 0); }
      100% { transform: translate(50px, 50px); }
    }

    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
    }

    body {
      display: flex;
      flex-direction: column;
      min-height: 100vh;
      width: 100%;
      max-width: 100%;
      padding: 0 2rem;
      line-height: 1.8;
      margin: 0;
    }

    /* Card View Styles */
    .view-toggle {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 1rem;
    }

    .view-btn {
      padding: 0.6rem 1.2rem;
      background: var(--chip-bg);
      border: 2px solid transparent;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.9rem;
      transition: all 0.2s;
      color: var(--text-color);
    }

    .view-btn.active {
      background: var(--accent-color);
      color: #000;
      font-weight: 600;
    }

    .ticket-cards {
      display: none;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 1.5rem;
      margin-top: 1.5rem;
    }

    .ticket-cards.active {
      display: grid;
    }

    .ticket-card {
      background: var(--glass-bg);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border: 2px solid var(--glass-border);
      border-radius: 12px;
      padding: 1.5rem;
      transition: all 0.3s;
      cursor: pointer;
      box-shadow: 0 8px 32px var(--shadow-color);
    }

    .ticket-card:hover {
      border-color: var(--accent-color);
      transform: translateY(-4px);
      box-shadow: 0 12px 40px var(--shadow-color);
    }

    .ticket-card-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 1rem;
    }

    .ticket-card-id {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--accent-color);
    }

    .ticket-card-priority {
      font-size: 2rem;
    }

    .ticket-card-topic {
      font-size: 1.1rem;
      font-weight: 600;
      margin-bottom: 0.5rem;
      color: var(--text-color);
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .ticket-card-info {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
      font-size: 0.85rem;
      opacity: 0.8;
    }

    .ticket-card-info > div {
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .ticket-card-status {
      display: inline-block;
      padding: 0.3rem 0.8rem;
      border-radius: 20px;
      font-size: 0.75rem;
      font-weight: 600;
      text-transform: uppercase;
    }

    .ticket-card-status.offen {
      background: #2bd94a;
      color: #000;
    }

    .ticket-card-status.geschlossen {
      background: #d92b2b;
      color: #fff;
    }

    table.hide {
      display: none;
    }

    [data-theme="dark"] .ticket-card {
      background: var(--chip-bg);
      border-color: var(--border-color);
    }

    [data-theme="dark"] .ticket-card:hover {
      border-color: var(--accent-color);
      box-shadow: 0 8px 16px rgba(0,255,136,0.3);
    }

    /* Mobile Responsive */
    @media (max-width: 768px) {
      body {
        padding: 0 1rem;
      }

      h1 { font-size: 1.5rem; }

      .controls .row {
        flex-direction: column !important;
        gap: 0.5rem !important;
      }

      #search {
        flex: 1 1 auto !important;
        min-width: 100% !important;
      }

      .chipbar {
        flex-wrap: wrap;
        justify-content: flex-start;
      }

      .chip {
        font-size: 0.65rem !important;
        padding: 0.4rem 0.8rem !important;
      }

      #refreshBar {
        flex-direction: column !important;
        gap: 0.5rem;
        padding: 0.7rem !important;
      }

      #refreshBar button {
        width: 100%;
      }

      /* Table Responsive */
      table {
        font-size: 0.75rem;
        overflow-x: auto;
        display: block;
      }

      thead th {
        padding: 0.6rem 0.5rem !important;
        font-size: 0.7rem !important;
      }

      tbody td {
        padding: 0.6rem 0.5rem !important;
      }

      /* Hide less important columns on mobile */
      thead th:nth-child(9), tbody td:nth-child(9),
      thead th:nth-child(8), tbody td:nth-child(8),
      thead th:nth-child(6), tbody td:nth-child(6) {
        display: none;
      }

      .badge {
        font-size: 0.6rem !important;
        padding: 0.15rem 0.35rem !important;
      }

      .theme-toggle {
        top: 0.5rem !important;
        right: 0.5rem !important;
        width: 2.5rem !important;
        height: 2.5rem !important;
        font-size: 1.2rem !important;
      }

      .back {
        font-size: 0.9rem !important;
      }

      label.inline {
        font-size: 0.7rem !important;
      }

      .view-toggle {
        width: 100%;
      }

      .view-btn {
        flex: 1;
        text-align: center;
      }

      .ticket-cards {
        grid-template-columns: 1fr;
        gap: 1rem;
      }

      .ticket-card {
        padding: 1.2rem;
      }
    }

    /* Tablet Responsive */
    @media (min-width: 769px) and (max-width: 1024px) {
      body {
        padding: 0 2rem;
      }

      table {
        font-size: 0.75rem;
      }

      /* Hide one column on tablet */
      thead th:nth-child(9), tbody td:nth-child(9) {
        display: none;
      }
    }

    main {
      flex: 1;
    }
    h1{display:flex;align-items:center;gap:.8rem;margin-bottom:.5rem;margin-top:2rem}
    .sub{font-size:.85rem;opacity:.7;margin:0 0 2rem}
    a.back{display:inline-flex;align-items:center;gap:.35rem;margin-bottom:1.4rem;text-decoration:none}
    .controls{display:flex;flex-direction:column;gap:.9rem;margin-bottom:.9rem}
    .controls .row{display:flex;flex-wrap:wrap;gap:.55rem;align-items:center}
    #search{flex:1 1 520px;min-width:280px}
    label.inline{display:flex;align-items:center;gap:.4rem;font-size:.72rem;white-space:nowrap}
    .chipbar{display:flex;flex-wrap:wrap;gap:.5rem}
    .chip{background:#eef0f5;border:0;padding:.46rem 1.05rem;border-radius:999px;font-size:.7rem;font-weight:500;cursor:pointer;line-height:1;user-select:none;transition:.15s}
    .chip.active{background:#4263eb;color:#fff;box-shadow:0 0 0 1px #4263eb}
    .chip.prio span{display:inline-block;width:.9rem;height:.9rem;border-radius:50%;}
    .chip.prio span.green{background:#2bd94a}
    .chip.prio span.orange{background:#ff9900}
    .chip.prio span.red{background:#d92b2b}
    #refreshBar{background:#13202b;color:#fff;border-radius:8px;padding:.85rem 1.1rem;display:flex;align-items:center;justify-content:space-between;margin-top:.4rem}
    #refreshBar button{background:#1e2d3a;border:0;color:#fff;padding:.55rem 1.1rem;border-radius:6px;cursor:pointer;font-size:.75rem;display:flex;align-items:center;gap:.45rem}
    table{width:100%;font-size:.8rem;border-collapse:collapse}
    thead th{white-space:nowrap;cursor:pointer;user-select:none;padding:.8rem 1rem;font-size:.75rem;letter-spacing:.5px;text-transform:uppercase}
    thead th.sortAsc:after{content:" \25B2"}
    thead th.sortDesc:after{content:" \25BC"}
    tbody td{padding:.8rem 1rem;vertical-align:middle;border-top:1px solid #e5e8ec;max-width:200px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
    tbody tr:hover{background:#f6f8fb}
    .badge{background:#e3e7ec;font-family:monospace;font-size:.65rem;padding:.2rem .45rem;border-radius:.4rem;display:inline-block;max-width:150px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
    .status-offen{color:#2bd94a;font-weight:600}
    .status-geschlossen{color:#d92b2b;font-weight:600}
    .prio-dot{font-size:1rem}
    .nowrap{white-space:nowrap}
    .trans-link{text-decoration:none}
    .details-btn{cursor:pointer;text-decoration:none}
    .form-data{font-size:.7rem;padding:.3rem;background:#f0f0f0;border:1px solid #ddd;border-radius:4px;margin-top:.3rem;display:none}
    .form-data.show{display:block}
    .form-data dt{font-weight:bold;margin-top:.3rem}
    .form-data dd{margin-left:1rem}
    tr.hide{display:none}
    footer{margin:2.2rem 0 .8rem;margin-bottom: 3rem; padding-bottom: 2rem; font-size:.65rem;opacity:.55}

    [data-theme="dark"] footer {
      margin-bottom: 4rem;
      padding-bottom: 3rem;
    }
    @media (max-width:880px){ thead th:nth-child(9), tbody td:nth-child(9){display:none} }
    @media (max-width:680px){ thead th:nth-child(8), tbody td:nth-child(8){display:none} }

    .theme-toggle {
      position: fixed;
      top: 1.5rem;
      right: 1.5rem;
      background: var(--accent-color);
      color: #000;
      border: 0;
      width: 3rem;
      height: 3rem;
      border-radius: 50%;
      cursor: pointer;
      font-size: 1.5rem;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s;
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
      z-index: 1000;
    }

    .theme-toggle:hover {
      transform: scale(1.1);
      background: var(--accent-hover);
    }

    [data-theme="dark"] .theme-toggle {
      background: var(--accent-color);
      box-shadow: 0 2px 12px rgba(0,255,136,0.4);
    }

    .nav-buttons {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 2rem;
      flex-wrap: wrap;
    }

    .nav-buttons a {
      padding: 0.6rem 1.2rem;
      background: var(--accent-color);
      color: #000;
      text-decoration: none;
      border-radius: 6px;
      font-size: 0.9rem;
      font-weight: 600;
      transition: all 0.2s;
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      border: 2px solid transparent;
    }

    .nav-buttons a:hover {
      background: var(--accent-hover);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,184,148,0.3);
    }

    [data-theme="dark"] .nav-buttons a {
      background: var(--accent-color);
      color: #000;
    }

    [data-theme="dark"] .nav-buttons a:hover {
      background: var(--accent-hover);
      box-shadow: 0 4px 12px rgba(0,255,136,0.4);
    }

    .nav-buttons a.secondary-btn {
      background: transparent;
      border-color: var(--accent-color);
      color: var(--accent-color);
    }

    .nav-buttons a.secondary-btn:hover {
      background: var(--accent-color);
      color: #000;
    }

    @media (max-width: 768px) {
      .nav-buttons {
        flex-direction: column;
      }

      .nav-buttons a {
        width: 100%;
        justify-content: center;
      }
    }

    /* Page Loading Animation */
    .page-loader {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(10,10,10,0.98);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 99999;
      transition: opacity 0.3s ease;
    }

    .page-loader.hide {
      opacity: 0;
      pointer-events: none;
    }

    .loader-content {
      text-align: center;
      background: rgba(255,255,255,0.05);
      padding: 3rem;
      border-radius: 20px;
      border: 1px solid rgba(0,255,136,0.2);
    }

    .loader-spinner {
      width: 60px;
      height: 60px;
      border: 6px solid rgba(0,255,136,0.1);
      border-top: 6px solid var(--accent-color);
      border-radius: 50%;
      animation: loaderSpin 1s linear infinite;
      margin: 0 auto 2rem;
    }

    .loader-text {
      font-size: 1.3rem;
      color: var(--accent-color);
      font-weight: 600;
      margin-bottom: 0.5rem;
    }

    .loader-subtext {
      font-size: 0.9rem;
      opacity: 0.7;
      color: var(--text-color);
    }

    @keyframes loaderSpin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* Navigation Loading Overlay */
    .nav-loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.95);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 100000;
      flex-direction: column;
      gap: 2rem;
    }

    .nav-loading-overlay.show {
      display: flex;
    }

    .nav-loader-content {
      text-align: center;
      background: rgba(255,255,255,0.05);
      padding: 3rem;
      border-radius: 20px;
      border: 1px solid rgba(0,255,136,0.2);
      max-width: 400px;
      width: 90%;
    }

    .nav-loader-spinner {
      width: 60px;
      height: 60px;
      border: 6px solid rgba(0,255,136,0.1);
      border-top: 6px solid var(--accent-color);
      border-radius: 50%;
      animation: loaderSpin 1s linear infinite;
      margin: 0 auto 2rem;
    }

    .nav-loader-text {
      font-size: 1.3rem;
      color: var(--accent-color);
      font-weight: 600;
      margin-bottom: 0.5rem;
    }

    .nav-loader-subtext {
      font-size: 0.9rem;
      opacity: 0.7;
      color: var(--text-color);
    }

    /* Transcript Modal */
    .transcript-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.95);
      backdrop-filter: blur(5px);
      z-index: 100001;
      animation: fadeIn 0.3s ease;
    }

    .transcript-modal.show {
      display: flex;
      justify-content: center;
      align-items: center;
    }

    .transcript-modal-content {
      background: var(--glass-bg);
      backdrop-filter: blur(20px);
      border: 2px solid var(--glass-border);
      border-radius: 1rem;
      width: 95%;
      max-width: 1400px;
      height: 90vh;
      box-shadow: 0 20px 60px var(--shadow-color);
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .transcript-modal-header {
      padding: 1.5rem 2rem;
      border-bottom: 2px solid var(--glass-border);
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: var(--chip-bg);
    }

    .transcript-modal-title {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--accent-color);
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }

    .transcript-modal-close {
      background: transparent;
      border: 2px solid var(--accent-color);
      color: var(--accent-color);
      width: 3rem;
      height: 3rem;
      border-radius: 50%;
      cursor: pointer;
      font-size: 1.5rem;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s;
    }

    .transcript-modal-close:hover {
      background: var(--accent-color);
      color: #000;
      transform: rotate(90deg);
    }

    .transcript-modal-body {
      flex: 1;
      overflow: hidden;
      padding: 0;
      position: relative;
    }

    .transcript-modal-iframe {
      width: 100%;
      height: 100%;
      border: none;
      background: #fff;
    }

    .transcript-modal-loading {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      text-align: center;
    }

    .transcript-modal-spinner {
      width: 60px;
      height: 60px;
      border: 6px solid rgba(0, 255, 136, 0.1);
      border-top: 6px solid var(--accent-color);
      border-radius: 50%;
      animation: loaderSpin 1s linear infinite;
      margin: 0 auto 1rem;
    }

    .transcript-modal-loading-text {
      font-size: 1.2rem;
      color: var(--accent-color);
      font-weight: 600;
    }

    @media (max-width: 768px) {
      .transcript-modal-content {
        width: 100%;
        height: 100vh;
        border-radius: 0;
      }

      .transcript-modal-header {
        padding: 1rem;
      }

      .transcript-modal-title {
        font-size: 1.2rem;
      }

      .transcript-modal-close {
        width: 2.5rem;
        height: 2.5rem;
        font-size: 1.2rem;
      }
    }
  </style>
</head>
<body>
  <!-- Page Loader -->
  <div class="page-loader" id="pageLoader">
    <div class="loader-content">
      <div class="loader-spinner"></div>
      <div class="loader-text">Lade Tickets...</div>
      <div class="loader-subtext">Bitte warten</div>
    </div>
  </div>

  <!-- Navigation Loading Overlay -->
  <div class="nav-loading-overlay" id="navLoadingOverlay">
    <div class="nav-loader-content">
      <div class="nav-loader-spinner"></div>
      <div class="nav-loader-text" id="navLoadingText">Wird geladen...</div>
      <div class="nav-loader-subtext">Bitte warten</div>
    </div>
  </div>

  <button class="theme-toggle" onclick="toggleTheme()" title="Dark Mode umschalten">
    <i id="themeIcon" class="fas fa-moon"></i>
  </button>
  <h1><i class="fas fa-ticket-alt"></i> Tickets Ãœbersicht</h1>
  <p class="sub">Nur fÃ¼r Team-Mitglieder sichtbar. Live-Daten aus <code>tickets.json</code>.</p>

  <div class="nav-buttons">
    <a href="/panel">
      <i class="fas fa-arrow-left"></i> <%= lang === 'de' ? 'ZurÃ¼ck zum Panel' : lang === 'en' ? 'Back to Panel' : lang === 'he' ? '×—×–×¨×” ×œ×¤×× ×œ' : lang === 'ja' ? 'ãƒ‘ãƒãƒ«ã«æˆ»ã‚‹' : lang === 'ru' ? 'ÐÐ°Ð·Ð°Ð´ Ðº Ð¿Ð°Ð½ÐµÐ»Ð¸' : lang === 'pt' ? 'Voltar ao Painel' : lang === 'es' ? 'Volver al Panel' : lang === 'id' ? 'Kembali ke Panel' : lang === 'zh' ? 'è¿”å›žé¢æ¿' : lang === 'ar' ? 'Ø§Ù„Ø¹ÙˆØ¯Ø© Ø¥Ù„Ù‰ Ø§Ù„Ù„ÙˆØ­Ø©' : 'ZurÃ¼ck zum Panel' %>
    </a>
    <a href="/" class="secondary-btn">
      <i class="fas fa-home"></i> <%= lang === 'de' ? 'Zur Startseite' : lang === 'en' ? 'Back to Home' : lang === 'he' ? '×—×–×¨×” ×œ×“×£ ×”×‘×™×ª' : lang === 'ja' ? 'ãƒ›ãƒ¼ãƒ ã«æˆ»ã‚‹' : lang === 'ru' ? 'ÐÐ° Ð³Ð»Ð°Ð²Ð½ÑƒÑŽ' : lang === 'pt' ? 'Voltar ao InÃ­cio' : lang === 'es' ? 'Volver al Inicio' : lang === 'id' ? 'Kembali ke Beranda' : lang === 'zh' ? 'è¿”å›žé¦–é¡µ' : lang === 'ar' ? 'Ø§Ù„Ø¹ÙˆØ¯Ø© Ø¥Ù„Ù‰ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©' : 'Zur Startseite' %>
    </a>
    <a href="/select-server" class="secondary-btn">
      <i class="fas fa-server"></i> <%= lang === 'de' ? 'Server wechseln' : lang === 'en' ? 'Change Server' : lang === 'he' ? '×”×—×œ×£ ×©×¨×ª' : lang === 'ja' ? 'ã‚µãƒ¼ãƒãƒ¼ã‚’å¤‰æ›´' : lang === 'ru' ? 'Ð¡Ð¼ÐµÐ½Ð¸Ñ‚ÑŒ ÑÐµÑ€Ð²ÐµÑ€' : lang === 'pt' ? 'Trocar Servidor' : lang === 'es' ? 'Cambiar Servidor' : lang === 'id' ? 'Ganti Server' : lang === 'zh' ? 'åˆ‡æ¢æœåŠ¡å™¨' : lang === 'ar' ? 'ØªØºÙŠÙŠØ± Ø§Ù„Ø®Ø§Ø¯Ù…' : 'Server wechseln' %>
    </a>
    <a href="https://discord.com/invite/mnYbnpyyBS" target="_blank" style="background: #5865F2; color: white;">
      <i class="fab fa-discord"></i> <%= lang === 'de' ? 'Support Server' : lang === 'en' ? 'Support Server' : lang === 'he' ? '×©×¨×ª ×ª×ž×™×›×”' : lang === 'ja' ? 'ã‚µãƒãƒ¼ãƒˆã‚µãƒ¼ãƒãƒ¼' : lang === 'ru' ? 'Ð¡ÐµÑ€Ð²ÐµÑ€ Ð¿Ð¾Ð´Ð´ÐµÑ€Ð¶ÐºÐ¸' : lang === 'pt' ? 'Servidor de Suporte' : lang === 'es' ? 'Servidor de Soporte' : lang === 'id' ? 'Server Dukungan' : lang === 'zh' ? 'æ”¯æŒæœåŠ¡å™¨' : lang === 'ar' ? 'Ø®Ø§Ø¯Ù… Ø§Ù„Ø¯Ø¹Ù…' : 'Support Server' %>
    </a>
  </div>

  <!-- Diese Variablen werden VOM Server (panel.js /tickets) gesetzt -->
  <script>
    window.__TICKETS = <%- tickets %>;
    window.__MEMBERS = <%- memberMap %>;
    window.GUILD_ID  = '<%= guildId %>';
  </script>

  <section class="controls">
    <div class="row">
      <input id="search" placeholder="Suche (ID, Topic, User, Claimer)" autocomplete="off">
      <label class="inline"><input type="checkbox" id="auto" checked> Auto-Refresh (30s)</label>
    </div>
    <div class="row chipbar" id="statusBar">
      <button class="chip active" data-status="alle">Alle</button>
      <button class="chip" data-status="offen">Offen</button>
      <button class="chip" data-status="geschlossen">Geschlossen</button>
      <button class="chip" data-claim="alle">Claimed+Unclaimed</button>
      <button class="chip" data-claim="claimed">Claimed</button>
      <button class="chip" data-claim="unclaimed">Unclaimed</button>
      <button class="chip active" data-prio="alle" id="prioAll">Prio: Alle</button>
      <button class="chip prio" data-prio="0" title="GrÃ¼n"><span class="green"></span></button>
      <button class="chip prio" data-prio="1" title="Orange"><span class="orange"></span></button>
      <button class="chip prio" data-prio="2" title="Rot"><span class="red"></span></button>
    </div>
    <div id="refreshBar"><button id="refreshBtn">ðŸ”„ Aktualisieren</button><span id="lastUpdate" style="font-size:.7rem;opacity:.75">Letztes Update: â€“</span></div>
  </section>

  <!-- View Toggle -->
  <div class="view-toggle">
    <button class="view-btn active" data-view="table"><i class="fas fa-table"></i> Tabelle</button>
    <button class="view-btn" data-view="cards"><i class="fas fa-th-large"></i> Karten</button>
  </div>

  <!-- Table View -->
  <table id="ticketsTable">
    <thead>
      <tr>
        <th data-sort="id">#</th>
        <th data-sort="priority">Prio</th>
        <th data-sort="status">Status</th>
        <th data-sort="topic">Topic</th>
        <th data-sort="userName">User</th>
        <th data-sort="claimerName">Claimer</th>
        <th data-sort="timestamp">Erstellt</th>
        <th>Details</th>
        <th data-sort="channelId">Kanal</th>
        <th>Transcript</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <!-- Card View -->
  <div class="ticket-cards" id="ticketCards"></div>

  <footer>
    <p>Quantix Tickets Â© 2025 Quantix Development â€¢ Alle Rechte vorbehalten â€¢ Version <%= version %></p>
    <p style="margin-top: 0.3rem;">Letztes Update: <span id="footerUpdate">â€“</span></p>
  </footer>

  <!-- Transcript Live View Modal -->
  <div class="transcript-modal" id="transcriptModal">
    <div class="transcript-modal-content">
      <div class="transcript-modal-header">
        <div class="transcript-modal-title">
          <i class="fas fa-file-alt"></i>
          <span id="transcriptTitle">Ticket Transcript</span>
        </div>
        <button class="transcript-modal-close" onclick="closeTranscriptModal()">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="transcript-modal-body">
        <div class="transcript-modal-loading" id="transcriptLoading">
          <div class="transcript-modal-spinner"></div>
          <div class="transcript-modal-loading-text">Transcript wird geladen...</div>
        </div>
        <iframe id="transcriptIframe" class="transcript-modal-iframe" style="display: none;"></iframe>
      </div>
    </div>
  </div>

<script>
  // Erwartet: server setzt window.__TICKETS, window.__MEMBERS und window.GUILD_ID
</script>
<script>
  const ticketsRaw = window.__TICKETS || [];
  const memberMap = window.__MEMBERS || {}; // { id: { display, tag, nickname, username } }
  const GUILD_ID = window.GUILD_ID || '';

  let tickets = ticketsRaw.slice();
  let sortKey = 'id';
  let sortDir = 'desc';
  let statusFilter = 'alle';
  let claimFilter = 'alle';
  let prioFilter = 'alle';

  const tbody = document.querySelector('#ticketsTable tbody');
  const dots = ['ðŸŸ¢','ðŸŸ ','ðŸ”´'];

  function displayName(id){
    if(!id) return '';
    const m = memberMap[id];
    if(!m) return id;
    return m.display || m.nickname || m.username || m.tag || id;
  }
  function fmt(ts){ const d=new Date(ts); return d.toLocaleDateString('de-DE',{day:'numeric',month:'numeric',year:'numeric'})+', '+d.toLocaleTimeString('de-DE',{hour:'2-digit',minute:'2-digit',second:'2-digit'}); }

  function apply(){
    let list = tickets.slice();
    if(statusFilter!=='alle') list = list.filter(t=>t.status===statusFilter);
    if(claimFilter==='claimed') list = list.filter(t=>!!t.claimer);
    if(claimFilter==='unclaimed') list = list.filter(t=>!t.claimer);
    if(prioFilter!=='alle') list = list.filter(t=>(t.priority||0)==+prioFilter);
    const q = document.getElementById('search').value.trim().toLowerCase();
    if(q) list = list.filter(t=> (
      String(t.id).includes(q) ||
      (t.topic||'').toLowerCase().includes(q) ||
      (t.userId||'').includes(q) ||
      (t.claimer||'').includes(q) ||
      displayName(t.userId).toLowerCase().includes(q) ||
      displayName(t.claimer).toLowerCase().includes(q)
    ));

    list.sort((a,b)=>{
      let av, bv;
      if(sortKey==='userName'){ av = displayName(a.userId).toLowerCase(); bv = displayName(b.userId).toLowerCase(); }
      else if(sortKey==='claimerName'){ av = displayName(a.claimer).toLowerCase(); bv = displayName(b.claimer).toLowerCase(); }
      else { av = a[sortKey]; bv = b[sortKey]; }
      if(['id','timestamp','priority'].includes(sortKey)){ av=Number(av)||0; bv=Number(bv)||0; }
      else { av=(av||'').toString().toLowerCase(); bv=(bv||'').toString().toLowerCase(); }
      if(av<bv) return sortDir==='asc'? -1:1;
      if(av>bv) return sortDir==='asc'? 1:-1;
      return 0;
    });
    render(list);
  }

  function render(list){
    // Render table view
    tbody.innerHTML = list.map(t=>{
      const pr = t.priority||0;
      const userName = displayName(t.userId);
      const claimerName = displayName(t.claimer);
      const hasFormData = t.formData && Object.keys(t.formData).length > 0;
      let formDataHtml = '';
      if(hasFormData){
        const entries = Object.entries(t.formData).map(([k,v])=>`<dt>${esc(k)}:</dt><dd>${esc(v||'â€”')}</dd>`).join('');
        formDataHtml = `<dl class="form-data" id="fd-${t.id}">${entries}</dl>`;
      }
      return `<tr data-status="${t.status}" data-claimed="${t.claimer? 'yes':'no'}" data-prio="${pr}">
        <td class="nowrap"><span class="badge">${t.id}</span></td>
        <td class="prio-dot">${dots[pr]}</td>
        <td class="status-${t.status}">${t.status}</td>
        <td>${t.topic||''}</td>
        <td><span class="badge" title="${t.userId||''}">${userName}</span></td>
        <td>${t.claimer? `<span class="badge" title="${t.claimer}">${claimerName}</span>`:''}</td>
        <td class="nowrap">${fmt(t.timestamp)}</td>
        <td>${hasFormData? `<span class="details-btn" onclick="toggleFormData(${t.id})">ðŸ“‹</span>${formDataHtml}`:''}</td>
        <td><a href="https://discord.com/channels/${GUILD_ID}/${t.channelId}" target="_blank" title="Channel Ã¶ffnen">ðŸ”—</a></td>
        <td><a class="trans-link" href="javascript:void(0)" onclick="openTranscriptModal(${t.id})" title="Transcript Live anzeigen">ðŸ“„</a></td>
      </tr>`;
    }).join('');

    // Render card view
    const cardsContainer = document.getElementById('ticketCards');
    cardsContainer.innerHTML = list.map(t=>{
      const pr = t.priority||0;
      const userName = displayName(t.userId);
      const claimerName = displayName(t.claimer);
      return `
        <div class="ticket-card" onclick="openTranscriptModal(${t.id})">
          <div class="ticket-card-header">
            <div class="ticket-card-id">#${t.id}</div>
            <div class="ticket-card-priority">${dots[pr]}</div>
          </div>
          <div class="ticket-card-topic">${t.topic||'Kein Thema'}</div>
          <div class="ticket-card-info">
            <div><strong>Status:</strong> <span class="ticket-card-status ${t.status}">${t.status}</span></div>
            <div><strong>User:</strong> ${userName}</div>
            ${t.claimer ? `<div><strong>Claimer:</strong> ${claimerName}</div>` : ''}
            <div><strong>Erstellt:</strong> ${fmt(t.timestamp)}</div>
          </div>
        </div>
      `;
    }).join('');
  }

  function toggleFormData(id){
    const el = document.getElementById('fd-'+id);
    if(el) el.classList.toggle('show');
  }
  function esc(s){return String(s).replace(/</g,'&lt;').replace(/>/g,'&gt;');}

  document.querySelectorAll('#ticketsTable thead th[data-sort]').forEach(th=>{
    th.addEventListener('click', ()=>{
      const k = th.dataset.sort;
      if(sortKey===k) sortDir = (sortDir==='asc'?'desc':'asc'); else { sortKey=k; sortDir='asc'; }
      document.querySelectorAll('#ticketsTable thead th').forEach(h=>h.classList.remove('sortAsc','sortDesc'));
      th.classList.add(sortDir==='asc'?'sortAsc':'sortDesc');
      apply();
    });
  });

  const statusBar = document.getElementById('statusBar');
  statusBar.addEventListener('click', e=>{
    const btn = e.target.closest('.chip'); if(!btn) return;
    if(btn.dataset.status){ statusFilter = btn.dataset.status; toggleActive('status', statusFilter); }
    if(btn.dataset.claim){ claimFilter = btn.dataset.claim; toggleActive('claim', claimFilter); }
    if(btn.dataset.prio){ prioFilter = btn.dataset.prio; toggleActive('prio', prioFilter); }
    apply();
  });
  function toggleActive(type, val){
    document.querySelectorAll(`.chip[data-${type}]`).forEach(c=>{ c.classList.toggle('active', c.getAttribute(`data-${type}`)===val); });
    if(type==='prio' && val!=='alle') document.getElementById('prioAll').classList.remove('active');
  }

  document.getElementById('search').addEventListener('input', apply);
  document.getElementById('refreshBtn').addEventListener('click', reloadData);

  function setTimes(){ const ts=new Date().toLocaleString('de-DE'); document.getElementById('lastUpdate').textContent='Letztes Update: '+ts; document.getElementById('footerUpdate').textContent=ts; }
  setTimes();
  setInterval(()=>{ if(document.getElementById('auto').checked) reloadData(); }, 30000);

  async function reloadData(){
    try { const r = await fetch('/tickets/data?_=' + Date.now()); if(!r.ok) return; tickets = await r.json(); setTimes(); apply(); } catch{}
  }

  apply();

  // View Toggle
  document.querySelectorAll('.view-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      const view = btn.dataset.view;

      // Toggle active class
      document.querySelectorAll('.view-btn').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');

      // Toggle view
      if(view === 'cards') {
        document.getElementById('ticketsTable').classList.add('hide');
        document.getElementById('ticketCards').classList.add('active');
        localStorage.setItem('trs-tickets-view', 'cards');
      } else {
        document.getElementById('ticketsTable').classList.remove('hide');
        document.getElementById('ticketCards').classList.remove('active');
        localStorage.setItem('trs-tickets-view', 'table');
      }
    });
  });

  // Load saved view preference
  (function() {
    const savedView = localStorage.getItem('trs-tickets-view') || 'table';
    if(savedView === 'cards') {
      document.querySelector('.view-btn[data-view="cards"]').click();
    }
  })();

  // Theme Toggle
  function toggleTheme() {
    const html = document.documentElement;
    const currentTheme = html.getAttribute('data-theme');
    const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
    html.setAttribute('data-theme', newTheme);
    localStorage.setItem('trs-theme', newTheme);
    document.getElementById('themeIcon').className = newTheme === 'dark' ? 'fas fa-sun' : 'fas fa-moon';
  }

  // Theme beim Laden setzen
  (function() {
    const savedTheme = localStorage.getItem('trs-theme') || 'light';
    document.documentElement.setAttribute('data-theme', savedTheme);
    document.getElementById('themeIcon').className = savedTheme === 'dark' ? 'fas fa-sun' : 'fas fa-moon';
  })();

  // Hide page loader when content is ready
  window.addEventListener('load', () => {
    setTimeout(() => {
      document.getElementById('pageLoader').classList.add('hide');
    }, 300);
  });

  // Navigation Loading Animations
  function showNavLoading(text) {
    const overlay = document.getElementById('navLoadingOverlay');
    const loadingText = document.getElementById('navLoadingText');

    loadingText.textContent = text;
    overlay.classList.add('show');
  }

  // Add loading to "ZurÃ¼ck zum Panel" button
  const panelBtn = document.querySelector('a[href="/panel"]');
  if (panelBtn) {
    panelBtn.addEventListener('click', function(e) {
      e.preventDefault();
      const href = this.getAttribute('href');

      showNavLoading('ZurÃ¼ck zum Panel...');

      setTimeout(() => {
        window.location.href = href;
      }, 100);
    });
  }

  // Add loading to "Zur Startseite" button
  const homeBtn = document.querySelector('a[href="/"]');
  if (homeBtn) {
    homeBtn.addEventListener('click', function(e) {
      e.preventDefault();
      const href = this.getAttribute('href');

      showNavLoading('Zur Startseite...');

      setTimeout(() => {
        window.location.href = href;
      }, 100);
    });
  }

  // Add loading to "Server wechseln" button
  const serverBtn = document.querySelector('a[href="/select-server"]');
  if (serverBtn) {
    serverBtn.addEventListener('click', function(e) {
      e.preventDefault();
      const href = this.getAttribute('href');

      showNavLoading('Server wird gewechselt...');

      setTimeout(() => {
        window.location.href = href;
      }, 100);
    });
  }

  // Transcript Modal Functions
  function openTranscriptModal(ticketId) {
    const modal = document.getElementById('transcriptModal');
    const iframe = document.getElementById('transcriptIframe');
    const loading = document.getElementById('transcriptLoading');
    const title = document.getElementById('transcriptTitle');

    // Set title
    title.textContent = `Ticket #${ticketId} Transcript`;

    // Show modal
    modal.classList.add('show');

    // Show loading, hide iframe
    loading.style.display = 'block';
    iframe.style.display = 'none';

    // Load transcript
    iframe.src = `/transcript/${ticketId}`;

    // Hide loading when iframe loads
    iframe.onload = function() {
      loading.style.display = 'none';
      iframe.style.display = 'block';
    };
  }

  function closeTranscriptModal() {
    const modal = document.getElementById('transcriptModal');
    const iframe = document.getElementById('transcriptIframe');

    modal.classList.remove('show');

    // Clear iframe after animation
    setTimeout(() => {
      iframe.src = '';
    }, 300);
  }

  // Close modal on overlay click
  document.getElementById('transcriptModal').addEventListener('click', function(e) {
    if (e.target === this) {
      closeTranscriptModal();
    }
  });

  // Close modal on Escape key
  document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
      const modal = document.getElementById('transcriptModal');
      if (modal.classList.contains('show')) {
        closeTranscriptModal();
      }
    }
  });
</script>
</body>
</html>
