<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8">
  <title>Tickets √úbersicht - TRS Tickets</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
      background: #000000;
      color: #00ff41;
      padding: 2rem;
      line-height: 1.6;
    }
    .container { max-width: 1400px; margin: 0 auto; }

    /* Header */
    h1 {
      display: flex;
      align-items: center;
      gap: .8rem;
      margin-bottom: .5rem;
      color: #00ff41;
      font-size: 2rem;
      text-shadow: 0 0 10px rgba(0, 255, 65, 0.5);
    }
    .sub {
      font-size: .85rem;
      color: #00cc33;
      margin: 0 0 1.5rem;
      opacity: .85;
    }

    /* Back Link */
    a.back {
      display: inline-flex;
      align-items: center;
      gap: .5rem;
      margin-bottom: 2rem;
      padding: .6rem 1.2rem;
      background: rgba(0, 255, 65, 0.1);
      border: 1px solid #00ff41;
      border-radius: 6px;
      text-decoration: none;
      color: #00ff41;
      font-weight: 500;
      transition: all .2s;
    }
    a.back:hover {
      background: rgba(0, 255, 65, 0.2);
      box-shadow: 0 0 15px rgba(0, 255, 65, 0.3);
      transform: translateX(-3px);
    }

    /* Controls */
    .controls {
      background: rgba(0, 255, 65, 0.05);
      border: 1px solid rgba(0, 255, 65, 0.3);
      border-radius: 10px;
      padding: 1.5rem;
      margin-bottom: 2rem;
    }
    .controls .row {
      display: flex;
      flex-wrap: wrap;
      gap: .8rem;
      align-items: center;
      margin-bottom: 1rem;
    }
    .controls .row:last-child { margin-bottom: 0; }

    /* Search Input */
    #search {
      flex: 1 1 400px;
      min-width: 250px;
      padding: .7rem 1rem;
      background: #0a0a0a;
      border: 2px solid #00ff41;
      border-radius: 6px;
      color: #00ff41;
      font-size: .95rem;
      outline: none;
      transition: all .2s;
    }
    #search:focus {
      box-shadow: 0 0 15px rgba(0, 255, 65, 0.4);
      border-color: #00ff41;
    }
    #search::placeholder { color: rgba(0, 255, 65, 0.5); }

    /* Checkbox */
    label.inline {
      display: flex;
      align-items: center;
      gap: .5rem;
      color: #00ff41;
      font-size: .85rem;
      white-space: nowrap;
      cursor: pointer;
    }
    input[type="checkbox"] {
      width: 18px;
      height: 18px;
      cursor: pointer;
      accent-color: #00ff41;
    }

    /* Chips */
    .chipbar {
      display: flex;
      flex-wrap: wrap;
      gap: .6rem;
    }
    .chip {
      background: rgba(0, 255, 65, 0.1);
      border: 1px solid #00ff41;
      color: #00ff41;
      padding: .5rem 1rem;
      border-radius: 20px;
      font-size: .75rem;
      font-weight: 500;
      cursor: pointer;
      user-select: none;
      transition: all .2s;
      white-space: nowrap;
    }
    .chip:hover {
      background: rgba(0, 255, 65, 0.2);
      box-shadow: 0 0 10px rgba(0, 255, 65, 0.3);
    }
    .chip.active {
      background: #00ff41;
      color: #000000;
      font-weight: 600;
      box-shadow: 0 0 15px rgba(0, 255, 65, 0.5);
    }
    .chip.prio span {
      display: inline-block;
      width: .9rem;
      height: .9rem;
      border-radius: 50%;
      margin-right: .3rem;
    }
    .chip.prio span.green { background: #2bd94a; }
    .chip.prio span.orange { background: #ff9900; }
    .chip.prio span.red { background: #d92b2b; }

    /* Refresh Bar */
    #refreshBar {
      background: rgba(0, 255, 65, 0.05);
      border: 1px solid rgba(0, 255, 65, 0.3);
      border-radius: 8px;
      padding: 1rem 1.3rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-top: 1rem;
    }
    #refreshBar button {
      background: rgba(0, 255, 65, 0.15);
      border: 1px solid #00ff41;
      color: #00ff41;
      padding: .6rem 1.2rem;
      border-radius: 6px;
      cursor: pointer;
      font-size: .8rem;
      font-weight: 500;
      display: flex;
      align-items: center;
      gap: .5rem;
      transition: all .2s;
    }
    #refreshBar button:hover {
      background: rgba(0, 255, 65, 0.25);
      box-shadow: 0 0 10px rgba(0, 255, 65, 0.3);
    }
    #lastUpdate { color: rgba(0, 255, 65, 0.7); font-size: .75rem; }

    /* Table */
    table {
      width: 100%;
      border-collapse: collapse;
      background: rgba(0, 255, 65, 0.02);
      border: 1px solid rgba(0, 255, 65, 0.3);
      border-radius: 10px;
      overflow: hidden;
    }
    thead th {
      background: rgba(0, 255, 65, 0.1);
      color: #00ff41;
      padding: .8rem .7rem;
      font-size: .75rem;
      font-weight: 600;
      letter-spacing: .8px;
      text-transform: uppercase;
      white-space: nowrap;
      cursor: pointer;
      user-select: none;
      border-bottom: 2px solid #00ff41;
      transition: all .2s;
    }
    thead th:hover {
      background: rgba(0, 255, 65, 0.15);
    }
    thead th.sortAsc:after { content: " ‚ñ≤"; opacity: .7; }
    thead th.sortDesc:after { content: " ‚ñº"; opacity: .7; }

    tbody td {
      padding: .8rem .7rem;
      vertical-align: middle;
      border-bottom: 1px solid rgba(0, 255, 65, 0.15);
      color: #00cc33;
      font-size: .85rem;
    }
    tbody tr {
      transition: all .2s;
    }
    tbody tr:hover {
      background: rgba(0, 255, 65, 0.08);
    }
    tbody tr:last-child td {
      border-bottom: none;
    }

    /* Badge */
    .badge {
      background: rgba(0, 255, 65, 0.15);
      color: #00ff41;
      border: 1px solid rgba(0, 255, 65, 0.4);
      font-family: 'Courier New', monospace;
      font-size: .7rem;
      padding: .25rem .6rem;
      border-radius: 5px;
      display: inline-block;
      font-weight: 500;
    }

    /* Status */
    .status-offen { color: #00ff41; font-weight: 600; text-shadow: 0 0 8px rgba(0, 255, 65, 0.4); }
    .status-geschlossen { color: #ff4444; font-weight: 600; }

    /* Priority Dot */
    .prio-dot { font-size: 1.2rem; }

    /* Links */
    .nowrap { white-space: nowrap; }
    a {
      color: #00ff41;
      text-decoration: none;
      transition: all .2s;
    }
    a:hover {
      color: #00ff41;
      text-shadow: 0 0 8px rgba(0, 255, 65, 0.6);
    }
    .trans-link, .details-btn {
      font-size: 1.2rem;
      cursor: pointer;
    }

    /* Form Data */
    .form-data {
      font-size: .75rem;
      padding: .8rem;
      background: rgba(0, 255, 65, 0.05);
      border: 1px solid rgba(0, 255, 65, 0.3);
      border-radius: 6px;
      margin-top: .5rem;
      display: none;
      color: #00cc33;
    }
    .form-data.show { display: block; }
    .form-data dt {
      font-weight: 600;
      color: #00ff41;
      margin-top: .5rem;
    }
    .form-data dt:first-child { margin-top: 0; }
    .form-data dd {
      margin-left: 1.2rem;
      color: #00cc33;
      margin-bottom: .3rem;
    }

    /* Footer */
    footer {
      margin: 2.5rem 0 1rem;
      font-size: .75rem;
      opacity: .6;
      color: #00cc33;
      text-align: center;
    }

    /* Code */
    code {
      background: rgba(0, 255, 65, 0.1);
      color: #00ff41;
      border: 1px solid rgba(0, 255, 65, 0.3);
      padding: .2rem .5rem;
      border-radius: 4px;
      font-family: 'Courier New', monospace;
    }

    /* Hide */
    tr.hide { display: none; }

    /* Responsive */
    @media (max-width: 880px) {
      thead th:nth-child(9), tbody td:nth-child(9) { display: none; }
    }
    @media (max-width: 680px) {
      thead th:nth-child(8), tbody td:nth-child(8) { display: none; }
      h1 { font-size: 1.5rem; }
      body { padding: 1rem; }
    }
  </style>
</head>
<body class="container">
  <h1>üé´ Tickets √úbersicht</h1>
  <p class="sub">Nur f√ºr Team-Mitglieder sichtbar. Live-Daten aus <code>tickets.json</code>.</p>
  <a href="/panel" class="back">‚¨ÖÔ∏è Zur√ºck zum Panel</a>

  <!-- Diese Variablen werden VOM Server (panel.js /tickets) gesetzt -->
  <script>
    window.__TICKETS = <%- tickets %>;
    window.__MEMBERS = <%- memberMap %>;
    window.GUILD_ID  = '<%= guildId %>';
  </script>

  <section class="controls">
    <div class="row">
      <input id="search" placeholder="Suche (ID, Topic, User, Claimer)" autocomplete="off">
      <label class="inline"><input type="checkbox" id="auto" checked> Auto-Refresh (30s)</label>
    </div>
    <div class="row chipbar" id="statusBar">
      <button class="chip active" data-status="alle">Alle</button>
      <button class="chip" data-status="offen">Offen</button>
      <button class="chip" data-status="geschlossen">Geschlossen</button>
      <button class="chip" data-claim="alle">Claimed+Unclaimed</button>
      <button class="chip" data-claim="claimed">Claimed</button>
      <button class="chip" data-claim="unclaimed">Unclaimed</button>
      <button class="chip active" data-prio="alle" id="prioAll">Prio: Alle</button>
      <button class="chip prio" data-prio="0" title="Gr√ºn"><span class="green"></span></button>
      <button class="chip prio" data-prio="1" title="Orange"><span class="orange"></span></button>
      <button class="chip prio" data-prio="2" title="Rot"><span class="red"></span></button>
    </div>
    <div id="refreshBar"><button id="refreshBtn">üîÑ Aktualisieren</button><span id="lastUpdate" style="font-size:.7rem;opacity:.75">Letztes Update: ‚Äì</span></div>
  </section>

  <table id="ticketsTable">
    <thead>
      <tr>
        <th data-sort="id">#</th>
        <th data-sort="priority">Prio</th>
        <th data-sort="status">Status</th>
        <th data-sort="topic">Topic</th>
        <th data-sort="userName">User</th>
        <th data-sort="claimerName">Claimer</th>
        <th data-sort="timestamp">Erstellt</th>
        <th>Details</th>
        <th data-sort="channelId">Kanal</th>
        <th>Transcript</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <footer>Ticket-Verlauf ‚Ä¢ Client-seitige Filter & Sortierung ‚Ä¢ Letztes Update: <span id="footerUpdate">‚Äì</span></footer>

<script>
  // Erwartet: server setzt window.__TICKETS, window.__MEMBERS und window.GUILD_ID
</script>
<script>
  const ticketsRaw = window.__TICKETS || [];
  const memberMap = window.__MEMBERS || {}; // { id: { display, tag, nickname, username } }
  const GUILD_ID = window.GUILD_ID || '';

  let tickets = ticketsRaw.slice();
  let sortKey = 'id';
  let sortDir = 'desc';
  let statusFilter = 'alle';
  let claimFilter = 'alle';
  let prioFilter = 'alle';

  const tbody = document.querySelector('#ticketsTable tbody');
  const dots = ['üü¢','üü†','üî¥'];

  function displayName(id){
    if(!id) return '';
    const m = memberMap[id];
    if(!m) return id;
    return m.display || m.nickname || m.username || m.tag || id;
  }
  function fmt(ts){ const d=new Date(ts); return d.toLocaleDateString('de-DE',{day:'numeric',month:'numeric',year:'numeric'})+', '+d.toLocaleTimeString('de-DE',{hour:'2-digit',minute:'2-digit',second:'2-digit'}); }

  function apply(){
    let list = tickets.slice();
    if(statusFilter!=='alle') list = list.filter(t=>t.status===statusFilter);
    if(claimFilter==='claimed') list = list.filter(t=>!!t.claimer);
    if(claimFilter==='unclaimed') list = list.filter(t=>!t.claimer);
    if(prioFilter!=='alle') list = list.filter(t=>(t.priority||0)==+prioFilter);
    const q = document.getElementById('search').value.trim().toLowerCase();
    if(q) list = list.filter(t=> (
      String(t.id).includes(q) ||
      (t.topic||'').toLowerCase().includes(q) ||
      (t.userId||'').includes(q) ||
      (t.claimer||'').includes(q) ||
      displayName(t.userId).toLowerCase().includes(q) ||
      displayName(t.claimer).toLowerCase().includes(q)
    ));

    list.sort((a,b)=>{
      let av, bv;
      if(sortKey==='userName'){ av = displayName(a.userId).toLowerCase(); bv = displayName(b.userId).toLowerCase(); }
      else if(sortKey==='claimerName'){ av = displayName(a.claimer).toLowerCase(); bv = displayName(b.claimer).toLowerCase(); }
      else { av = a[sortKey]; bv = b[sortKey]; }
      if(['id','timestamp','priority'].includes(sortKey)){ av=Number(av)||0; bv=Number(bv)||0; }
      else { av=(av||'').toString().toLowerCase(); bv=(bv||'').toString().toLowerCase(); }
      if(av<bv) return sortDir==='asc'? -1:1;
      if(av>bv) return sortDir==='asc'? 1:-1;
      return 0;
    });
    render(list);
  }

  function render(list){
    tbody.innerHTML = list.map(t=>{
      const pr = t.priority||0;
      const userName = displayName(t.userId);
      const claimerName = displayName(t.claimer);
      const hasFormData = t.formData && Object.keys(t.formData).length > 0;
      let formDataHtml = '';
      if(hasFormData){
        const entries = Object.entries(t.formData).map(([k,v])=>`<dt>${esc(k)}:</dt><dd>${esc(v||'‚Äî')}</dd>`).join('');
        formDataHtml = `<dl class="form-data" id="fd-${t.id}">${entries}</dl>`;
      }
      return `<tr data-status="${t.status}" data-claimed="${t.claimer? 'yes':'no'}" data-prio="${pr}">
        <td class="nowrap"><span class="badge">${t.id}</span></td>
        <td class="prio-dot">${dots[pr]}</td>
        <td class="status-${t.status}">${t.status}</td>
        <td>${t.topic||''}</td>
        <td><span class="badge" title="${t.userId||''}">${userName}</span></td>
        <td>${t.claimer? `<span class="badge" title="${t.claimer}">${claimerName}</span>`:''}</td>
        <td class="nowrap">${fmt(t.timestamp)}</td>
        <td>${hasFormData? `<span class="details-btn" onclick="toggleFormData(${t.id})">üìã</span>${formDataHtml}`:''}</td>
        <td><a href="https://discord.com/channels/${GUILD_ID}/${t.channelId}" target="_blank" title="Channel √∂ffnen">üîó</a></td>
        <td><a class="trans-link" href="/transcript/${t.id}" target="_blank" title="Transcript √∂ffnen">üìÑ</a></td>
      </tr>`;
    }).join('');
  }

  function toggleFormData(id){
    const el = document.getElementById('fd-'+id);
    if(el) el.classList.toggle('show');
  }
  function esc(s){return String(s).replace(/</g,'&lt;').replace(/>/g,'&gt;');}

  document.querySelectorAll('#ticketsTable thead th[data-sort]').forEach(th=>{
    th.addEventListener('click', ()=>{
      const k = th.dataset.sort;
      if(sortKey===k) sortDir = (sortDir==='asc'?'desc':'asc'); else { sortKey=k; sortDir='asc'; }
      document.querySelectorAll('#ticketsTable thead th').forEach(h=>h.classList.remove('sortAsc','sortDesc'));
      th.classList.add(sortDir==='asc'?'sortAsc':'sortDesc');
      apply();
    });
  });

  const statusBar = document.getElementById('statusBar');
  statusBar.addEventListener('click', e=>{
    const btn = e.target.closest('.chip'); if(!btn) return;
    if(btn.dataset.status){ statusFilter = btn.dataset.status; toggleActive('status', statusFilter); }
    if(btn.dataset.claim){ claimFilter = btn.dataset.claim; toggleActive('claim', claimFilter); }
    if(btn.dataset.prio){ prioFilter = btn.dataset.prio; toggleActive('prio', prioFilter); }
    apply();
  });
  function toggleActive(type, val){
    document.querySelectorAll(`.chip[data-${type}]`).forEach(c=>{ c.classList.toggle('active', c.getAttribute(`data-${type}`)===val); });
    if(type==='prio' && val!=='alle') document.getElementById('prioAll').classList.remove('active');
  }

  document.getElementById('search').addEventListener('input', apply);
  document.getElementById('refreshBtn').addEventListener('click', reloadData);

  function setTimes(){ const ts=new Date().toLocaleString('de-DE'); document.getElementById('lastUpdate').textContent='Letztes Update: '+ts; document.getElementById('footerUpdate').textContent=ts; }
  setTimes();
  setInterval(()=>{ if(document.getElementById('auto').checked) reloadData(); }, 30000);

  async function reloadData(){
    try { const r = await fetch('/tickets/data?_=' + Date.now()); if(!r.ok) return; tickets = await r.json(); setTimes(); apply(); } catch{}
  }

  apply();
</script>
</body>
</html>
