<!doctype html>
<html lang="de" data-theme="light">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0">
  <title>Ticket‚ÄëBot Panel</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@1/css/pico.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  <link rel="stylesheet" href="/markdown.css">
  <style>
    :root {
      --bg-color: #fff;
      --text-color: #1a1a1a;
      --border-color: #e5e8ec;
      --accent-color: #00b894;
      --accent-hover: #00a077;
      --fieldset-bg: #f8f9fa;
      --thead-bg: #f2f4f8;
      --input-bg: #fff;
      --code-bg: #f0f0f0;
      --success-bg: #d1f2eb;
      --success-border: #2bb780;
      --error-bg: #f8d7da;
      --error-border: #c33;
    }

    [data-theme="dark"] {
      --bg-color: #0a0a0a;
      --text-color: #00ff88;
      --border-color: #1a3a2a;
      --accent-color: #00ff88;
      --accent-hover: #00dd77;
      --fieldset-bg: #0f1510;
      --thead-bg: #0f1f15;
      --input-bg: #0f1510;
      --code-bg: #0a1a0f;
      --success-bg: #0a2015;
      --success-border: #00ff88;
      --error-bg: #2a0a0a;
      --error-border: #ff4444;
    }

    [data-theme="dark"] body {
      background-color: var(--bg-color);
      color: var(--text-color);
    }

    [data-theme="dark"] input,
    [data-theme="dark"] select,
    [data-theme="dark"] textarea {
      background-color: var(--input-bg);
      border-color: var(--border-color);
      color: var(--text-color);
    }

    [data-theme="dark"] fieldset {
      background-color: var(--fieldset-bg);
      border-color: var(--border-color);
    }

    [data-theme="dark"] thead {
      background: var(--thead-bg);
    }

    [data-theme="dark"] code {
      background: var(--code-bg);
      color: var(--accent-color);
    }

    [data-theme="dark"] .good {
      background: var(--success-bg);
      border-color: var(--success-border);
      color: var(--accent-color);
    }

    [data-theme="dark"] .bad {
      background: var(--error-bg);
      border-color: var(--error-border);
      color: #ff6666;
    }

    [data-theme="dark"] a {
      color: var(--accent-color);
    }

    [data-theme="dark"] button:not(.del-btn):not(.theme-toggle) {
      background-color: var(--accent-color);
      color: #000;
    }

    [data-theme="dark"] button:not(.del-btn):not(.theme-toggle):hover {
      background-color: var(--accent-hover);
    }

    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
    }

    body {
      display: flex;
      flex-direction: column;
      min-height: 100vh;
      width: 100%;
      max-width: 100%;
      padding: 0 2rem;
      line-height: 1.8;
      margin: 0;
    }

    /* Mobile Responsive */
    @media (max-width: 768px) {
      body {
        padding: 0 1rem;
      }

      h1 { font-size: 1.5rem; }

      table { font-size: 0.85rem; overflow-x: auto; display: block; }
      th, td { padding: 0.4rem 0.6rem !important; }

      .grid { flex-direction: column !important; }
      fieldset { min-width: 100% !important; padding: 1rem !important; }

      textarea { font-size: 0.9rem; }
      input, select { font-size: 0.9rem; }

      .add-btn, button[type="submit"] {
        width: 100%;
        padding: 0.8rem !important;
      }

      .actions form {
        display: block !important;
        width: 100%;
        margin-bottom: 0.5rem !important;
      }

      .actions select,
      .actions button {
        width: 100% !important;
        margin-right: 0 !important;
        margin-bottom: 0.5rem;
      }

      .theme-toggle {
        top: 0.5rem !important;
        right: 0.5rem !important;
        width: 2.5rem !important;
        height: 2.5rem !important;
        font-size: 1.2rem !important;
      }

      [style*="position: fixed"] select {
        top: 0.5rem !important;
        right: 3.5rem !important;
        font-size: 0.85rem !important;
        padding: 0.5rem !important;
      }

      .header-flex {
        flex-direction: column;
        align-items: flex-start !important;
        gap: 1rem;
      }

      /* Tabellen horizontal scrollbar */
      table {
        min-width: 600px;
      }

      /* Formfelder Stack */
      .topic-row {
        flex-direction: column !important;
        gap: 0.5rem !important;
      }

      .topic-row input {
        width: 100% !important;
      }
    }

    /* Tablet Responsive */
    @media (min-width: 769px) and (max-width: 1024px) {
      body {
        padding: 0 2rem;
      }

      .grid {
        gap: 1.5rem !important;
      }

      fieldset {
        flex: 1 1 600px !important;
        min-width: 500px !important;
      }
    }

    main {
      flex: 1;
    }
    table { width:100%; border-collapse:collapse; }
    th,td { padding:.6rem .8rem; }
    table input, table select { width:100%; }
    .grid { display:flex; flex-wrap:wrap; gap:2rem; }
    fieldset { flex:1 1 800px; min-width:740px; padding:2rem; }
    textarea { width:100%; font-family: monospace; resize:vertical; }
    .bad { border:1px solid var(--error-border); padding:1rem 1.5rem; border-radius:6px; background: var(--error-bg); margin:1rem 0; }
    .good { border:1px solid var(--success-border); padding:1rem 1.5rem; border-radius:6px; background: var(--success-bg); margin:1rem 0; }
    .actions form { display:inline-block; margin-right:1rem; }
    footer { margin-top:3rem; margin-bottom: 3rem; padding-bottom: 2rem; font-size:.7rem; opacity:.6; }

    [data-theme="dark"] footer {
      margin-bottom: 4rem;
      padding-bottom: 3rem;
    }
    .placeholder-list code { margin-right:.4rem; }
    .add-btn { margin-top:.5rem; }
    .soft-note { font-size:.7rem; opacity:.65; }
    .del-btn { background:#e55353; color:#fff; border:0; padding:.25rem .55rem; border-radius:4px; cursor:pointer; font-size:.7rem; }
    .del-btn:hover { background:#c84242; }
    thead { background: var(--thead-bg); }
    .mini { font-size:.65rem; opacity:.55; }

    .theme-toggle {
      position: fixed;
      top: 1.5rem;
      right: 1.5rem;
      background: var(--accent-color);
      color: #000;
      border: 0;
      width: 3rem;
      height: 3rem;
      border-radius: 50%;
      cursor: pointer;
      font-size: 1.5rem;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s;
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
      z-index: 1000;
    }

    .theme-toggle:hover {
      transform: scale(1.1);
      background: var(--accent-hover);
    }

    [data-theme="dark"] .theme-toggle {
      background: var(--accent-color);
      box-shadow: 0 2px 12px rgba(0,255,136,0.4);
    }

    .header-flex {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
    }

    .server-info {
      font-size: 0.85rem;
      opacity: 0.7;
    }

    [data-theme="dark"] .server-info {
      color: var(--accent-color);
    }

    [data-theme="dark"] select {
      background: var(--accent-color) !important;
      color: #000 !important;
    }

    .nav-buttons {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 2rem;
      flex-wrap: wrap;
    }

    .nav-buttons a {
      padding: 0.6rem 1.2rem;
      background: var(--accent-color);
      color: #000;
      text-decoration: none;
      border-radius: 6px;
      font-size: 0.9rem;
      font-weight: 600;
      transition: all 0.2s;
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      border: 2px solid transparent;
    }

    .nav-buttons a:hover {
      background: var(--accent-hover);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,184,148,0.3);
    }

    [data-theme="dark"] .nav-buttons a {
      background: var(--accent-color);
      color: #000;
    }

    [data-theme="dark"] .nav-buttons a:hover {
      background: var(--accent-hover);
      box-shadow: 0 4px 12px rgba(0,255,136,0.4);
    }

    .nav-buttons a.secondary-btn {
      background: transparent;
      border-color: var(--accent-color);
      color: var(--accent-color);
    }

    .nav-buttons a.secondary-btn:hover {
      background: var(--accent-color);
      color: #000;
    }

    @media (max-width: 768px) {
      .nav-buttons {
        flex-direction: column;
      }

      .nav-buttons a {
        width: 100%;
        justify-content: center;
      }
    }
  </style>
</head>
<body>
  <div style="position: fixed; top: 1.5rem; right: 5.5rem; z-index: 1000;">
    <select onchange="window.location.href='/set-language/' + this.value" style="background: var(--accent-color); color: #000; border: 0; padding: 0.75rem; border-radius: 8px; cursor: pointer; font-size: 0.9rem; box-shadow: 0 2px 8px rgba(0,0,0,0.2);">
      <option value="de" <%= lang === 'de' ? 'selected' : '' %>>üá©üá™ Deutsch</option>
      <option value="en" <%= lang === 'en' ? 'selected' : '' %>>üá¨üáß English</option>
      <option value="he" <%= lang === 'he' ? 'selected' : '' %>>üáÆüá± ◊¢◊ë◊®◊ô◊™</option>
      <option value="ja" <%= lang === 'ja' ? 'selected' : '' %>>üáØüáµ Êó•Êú¨Ë™û</option>
      <option value="ru" <%= lang === 'ru' ? 'selected' : '' %>>üá∑üá∫ –†—É—Å—Å–∫–∏–π</option>
      <option value="pt" <%= lang === 'pt' ? 'selected' : '' %>>üáµüáπ Portugu√™s</option>
    </select>
  </div>
  <button class="theme-toggle" onclick="toggleTheme()" title="Dark Mode umschalten">
    <i id="themeIcon" class="fas fa-moon"></i>
  </button>
  <h1><i class="fas fa-ticket-alt"></i> <%= t.web.title %></h1>

  <div class="nav-buttons">
    <a href="/">
      <i class="fas fa-home"></i> <%= lang === 'de' ? 'Zur Startseite' : lang === 'en' ? 'Back to Home' : lang === 'he' ? '◊ó◊ñ◊®◊î ◊ú◊ì◊£ ◊î◊ë◊ô◊™' : lang === 'ja' ? '„Éõ„Éº„É†„Å´Êàª„Çã' : lang === 'ru' ? '–ù–∞ –≥–ª–∞–≤–Ω—É—é' : lang === 'pt' ? 'Voltar ao In√≠cio' : 'Zur Startseite' %>
    </a>
    <a href="/select-server" class="secondary-btn">
      <i class="fas fa-server"></i> <%= lang === 'de' ? 'Server wechseln' : lang === 'en' ? 'Change Server' : lang === 'he' ? '◊î◊ó◊ú◊£ ◊©◊®◊™' : lang === 'ja' ? '„Çµ„Éº„Éê„Éº„ÇíÂ§âÊõ¥' : lang === 'ru' ? '–°–º–µ–Ω–∏—Ç—å —Å–µ—Ä–≤–µ—Ä' : lang === 'pt' ? 'Trocar Servidor' : 'Server wechseln' %>
    </a>
    <a href="/tickets" class="secondary-btn">
      <i class="fas fa-history"></i> <%= lang === 'de' ? 'Ticket-Verlauf' : lang === 'en' ? 'Ticket History' : lang === 'he' ? '◊î◊ô◊°◊ò◊ï◊®◊ô◊ô◊™ ◊õ◊®◊ò◊ô◊°◊ô◊ù' : lang === 'ja' ? '„ÉÅ„Ç±„ÉÉ„ÉàÂ±•Ê≠¥' : lang === 'ru' ? '–ò—Å—Ç–æ—Ä–∏—è —Ç–∏–∫–µ—Ç–æ–≤' : lang === 'pt' ? 'Hist√≥rico de Tickets' : 'Ticket-Verlauf' %>
    </a>
  </div>

  <% if (msg==='saved')  { %><p class="good"><%= t.web.messages.saved %></p><% } %>
  <% if (msg==='sent')   { %><p class="good"><%= t.web.messages.sent %></p><% } %>
  <% if (msg==='edited') { %><p class="good"><%= t.web.messages.edited %></p><% } %>
  <% if (msg==='nopanel'){ %><p class="bad"><%= t.web.messages.nopanel %></p><% } %>
  <% if (msg==='error')  { %><p class="bad"><%= t.web.messages.error %></p><% } %>

  <form method="POST" autocomplete="off" id="panelForm">
    <div class="grid">

      <!-- Server Einstellungen -->
      <fieldset>
        <legend><i class="fas fa-server"></i> <%= t.web.server_settings %></legend>
        <label><%= t.web.guild_id %>
          <input name="guildId" value="<%= cfg.guildId || guildId || '' %>" placeholder="1234567890123456789" readonly style="background: var(--fieldset-bg); cursor: not-allowed;">
        </label>
        <label><%= t.web.ticket_category %>
          <select name="ticketCategoryId">
            <option value=""><%= t.web.select_category %></option>
            <% channels.filter(ch => ch.type === 4).forEach(ch => { %>
              <option value="<%= ch.id %>" <%= cfg.ticketCategoryId === ch.id ? 'selected' : '' %>>
                üìÅ <%= ch.name %>
              </option>
            <% }) %>
          </select>
        </label>
        <label><%= t.web.log_channel %>
          <select name="logChannelId">
            <option value=""><%= t.web.select_channel %></option>
            <% channels.filter(ch => ch.type === 0).forEach(ch => { %>
              <option value="<%= ch.id %>" <%= cfg.logChannelId === ch.id ? 'selected' : '' %>>
                # <%= ch.name %>
              </option>
            <% }) %>
          </select>
        </label>
        <label><%= t.web.transcript_channel %>
          <select name="transcriptChannelId">
            <option value=""><%= t.web.select_channel %></option>
            <% channels.filter(ch => ch.type === 0).forEach(ch => { %>
              <option value="<%= ch.id %>" <%= cfg.transcriptChannelId === ch.id ? 'selected' : '' %>>
                # <%= ch.name %>
              </option>
            <% }) %>
          </select>
        </label>
        <label><%= t.web.team_role %> (Legacy)
          <select name="teamRoleId">
            <option value=""><%= t.web.select_role %></option>
            <% roles.forEach(role => { %>
              <option value="<%= role.id %>" <%= cfg.teamRoleId === role.id ? 'selected' : '' %>>
                @ <%= role.name %>
              </option>
            <% }) %>
          </select>
        </label>
        <p class="soft-note">Guild ID wird automatisch gesetzt. Legacy Team-Rolle f√ºr R√ºckw√§rtskompatibilit√§t.</p>
      </fieldset>

      <!-- Priority Rollen (NEU) -->
      <fieldset>
        <legend><i class="fas fa-users-cog"></i> Priorit<%= lang === 'he' ? '◊ô◊ï◊™' : '√§' %>ts-Rollen (Multi-Level)</legend>
        <p class="soft-note">Lege fest welche Rollen Zugriff auf Tickets mit spezifischer Priorit<%= lang === 'he' ? '◊ô◊ï◊™' : '√§' %>t haben. Mehrfachauswahl mit STRG/CMD.</p>

        <label>üü¢ Gr√ºn (Niedrig) - Rollen
          <select name="priorityRoles_0" multiple size="5" style="height: auto;">
            <%
            const green = (cfg.priorityRoles && cfg.priorityRoles['0']) || [];
            roles.forEach(role => { %>
              <option value="<%= role.id %>" <%= green.includes(role.id) ? 'selected' : '' %>>
                @ <%= role.name %>
              </option>
            <% }) %>
          </select>
        </label>

        <label>üü† Orange (Mittel) - Rollen
          <select name="priorityRoles_1" multiple size="5" style="height: auto;">
            <%
            const orange = (cfg.priorityRoles && cfg.priorityRoles['1']) || [];
            roles.forEach(role => { %>
              <option value="<%= role.id %>" <%= orange.includes(role.id) ? 'selected' : '' %>>
                @ <%= role.name %>
              </option>
            <% }) %>
          </select>
        </label>

        <label>üî¥ Rot (Hoch) - Rollen
          <select name="priorityRoles_2" multiple size="5" style="height: auto;">
            <%
            const red = (cfg.priorityRoles && cfg.priorityRoles['2']) || [];
            roles.forEach(role => { %>
              <option value="<%= role.id %>" <%= red.includes(role.id) ? 'selected' : '' %>>
                @ <%= role.name %>
              </option>
            <% }) %>
          </select>
        </label>

        <div class="soft-note" style="margin-top: 1rem; padding: 1rem; background: var(--fieldset-bg); border-radius: 6px; border-left: 4px solid var(--accent-color);">
          <strong>üìù Vorschau:</strong><br>
          <span style="font-size: 0.85rem;">
            üü¢ Gr√ºn: <%= green.length %> Rolle(n) |
            üü† Orange: <%= orange.length %> Rolle(n) |
            üî¥ Rot: <%= red.length %> Rolle(n)
          </span>
        </div>
      </fieldset>

      <!-- GitHub Commit Logs (NEU) -->
      <fieldset>
        <legend><i class="fab fa-github"></i> GitHub Commit Logs</legend>
        <p class="soft-note">Konfiguriere wo GitHub Commits vom TRS-Tickets-Bot Repository geloggt werden sollen.</p>

        <label>üì¢ GitHub Webhook Channel
          <select name="githubWebhookChannelId">
            <option value=""><%= t.web.select_channel %></option>
            <% channels.filter(ch => ch.type === 0).forEach(ch => { %>
              <option value="<%= ch.id %>" <%= cfg.githubWebhookChannelId === ch.id ? 'selected' : '' %>>
                # <%= ch.name %>
              </option>
            <% }) %>
          </select>
        </label>

        <div style="margin-top: 1rem; padding: 1rem; background: var(--fieldset-bg); border-radius: 6px; border-left: 4px solid <%= cfg.githubCommitsEnabled !== false ? '#00ff88' : '#ff4444' %>;">
          <strong>Status:</strong>
          <%= cfg.githubCommitsEnabled !== false ? '‚úÖ Aktiviert' : '‚ùå Deaktiviert' %>
          <br>
          <span style="font-size: 0.85rem; opacity: 0.8;">
            Verwende den <code>/github-commits</code> Command im Discord um den Status zu √§ndern.
          </span>
          <% if (cfg.githubWebhookChannelId) { %>
            <br>
            <span style="font-size: 0.85rem; opacity: 0.8;">
              Logs werden gesendet an: <strong><%= channels.find(ch => ch.id === cfg.githubWebhookChannelId)?.name || 'Unbekannt' %></strong>
            </span>
          <% } else { %>
            <br>
            <span style="font-size: 0.85rem; opacity: 0.8; color: #ff6666;">
              ‚ö†Ô∏è Kein Webhook-Channel ausgew√§hlt! Bitte w√§hle einen Channel aus.
            </span>
          <% } %>
        </div>

        <p class="soft-note" style="margin-top: 1rem;">
          üí° <strong>Webhook URL Setup:</strong><br>
          1. W√§hle oben den Channel aus<br>
          2. Speichere die Einstellungen<br>
          3. F√ºge in deinem GitHub Repository die Webhook-URL hinzu:<br>
          <code style="font-size: 0.75rem; word-break: break-all;">
            <%= process.env.PUBLIC_BASE_URL || 'https://trstickets.theredstonee.de' %>/webhook/github
          </code><br>
          4. Content-Type: <code>application/json</code><br>
          5. Event: <strong>Pushes</strong> (oder "Just the push event")
        </p>
      </fieldset>

      <!-- Topics -->
      <fieldset>
        <legend><%= t.web.topics %></legend>
        <table>
          <thead>
            <tr><th><%= t.web.topic_label %>*</th><th><%= t.web.topic_value %></th><th><%= t.web.topic_emoji %></th><th><%= t.web.delete %></th></tr>
          </thead>
          <tbody id="topicRows">
            <% (cfg.topics||[]).forEach(topic=>{ %>
              <tr>
                <td><input name="label" value="<%= topic.label %>" required></td>
                <td><input name="value" value="<%= topic.value %>" placeholder="auto"></td>
                <td><input name="emoji" value="<%= topic.emoji||'' %>"></td>
                <td><button type="button" class="del-btn" onclick="delRow(this)">‚úñ</button></td>
              </tr>
            <% }) %>
          </tbody>
        </table>
        <button type="button" class="add-btn" onclick="addTopicRow()">‚ûï Topic</button>
        <p class="soft-note">Ist <b>Value</b> leer, wird es aus dem Label generiert (klein + Bindestriche).</p>
      </fieldset>

      <!-- Ticket Embed -->
      <fieldset>
        <legend><%= t.web.ticket_embed %></legend>
        <p class="placeholder-list soft-note"><%= t.web.placeholders %>: <code>{userMention}</code> <code>{userId}</code> <code>{topicLabel}</code> <code>{topicValue}</code> <code>{ticketNumber}</code></p>
        <label><%= t.web.embed_title %> <input name="embedTitle" value="<%= cfg.ticketEmbed?.title || '' %>"></label>
        <label><%= t.web.embed_description %> <textarea name="embedDescription" rows="7"><%= cfg.ticketEmbed?.description || '' %></textarea></label>
        <label><%= t.web.embed_color %> <input name="embedColor" value="<%= cfg.ticketEmbed?.color || '#2b90d9' %>" placeholder="#2b90d9"></label>
        <label><%= t.web.embed_footer %> <input name="embedFooter" value="<%= cfg.ticketEmbed?.footer || '' %>"></label>
      </fieldset>

      <!-- Panel Embed -->
      <fieldset>
        <legend><%= t.web.panel_embed %></legend>
        <label><%= t.web.embed_title %> <input name="panelTitle" value="<%= cfg.panelEmbed?.title || '' %>"></label>
        <label><%= t.web.embed_description %> <textarea name="panelDescription" rows="6"><%= cfg.panelEmbed?.description || '' %></textarea></label>
        <label><%= t.web.embed_color %> <input name="panelColor" value="<%= cfg.panelEmbed?.color || '#5865F2' %>" placeholder="#5865F2"></label>
        <label><%= t.web.embed_footer %> <input name="panelFooter" value="<%= cfg.panelEmbed?.footer || '' %>"></label>
      </fieldset>

      <!-- Formular Felder -->
      <fieldset>
        <legend>Benutzer‚ÄëFormular Felder</legend>
        <p class="soft-note">Diese Felder MUSS der Nutzer beim Ticket erstellen ausf√ºllen (Modal √∂ffnet sich nach Themenwahl).</p>
        <table>
          <thead>
            <tr><th>Label*</th><th>Placeholder</th><th>Typ</th><th>Required</th><th>L√∂schen</th></tr>
          </thead>
          <tbody id="formRows">
            <% (cfg.formFields||[]).forEach(f=>{ %>
              <tr>
                <td><input name="ffLabel" value="<%= f.label %>" required></td>
                <td><input name="ffPlaceholder" value="<%= f.placeholder||'' %>"></td>
                <td>
                  <select name="ffType">
                    <option value="short" <%= f.type==='short'?'selected':'' %>>Kurz</option>
                    <option value="paragraph" <%= f.type==='paragraph'?'selected':'' %>>Lang</option>
                    <option value="number" <%= f.type==='number'?'selected':'' %>>Zahl</option>
                  </select>
                </td>
                <td style="text-align:center"><input type="checkbox" name="ffRequired" <%= f.required? 'checked':'' %>></td>
                <td><button type="button" class="del-btn" onclick="delRow(this)">‚úñ</button></td>
              </tr>
            <% }) %>
          </tbody>
        </table>
        <button type="button" class="add-btn" onclick="addFormRow()">‚ûï Feld</button>
        <p class="soft-note mini">Typen: <b>short</b> = kurzer Text, <b>paragraph</b> = langer Text, <b>number</b> = numerisch (als Text gespeichert).</p>
        <label class="soft-note">FormFields (JSON Vorschau)
          <textarea id="formFieldsJson" name="formFieldsJson" rows="8"><%= JSON.stringify(cfg.formFields || [], null, 2) %></textarea>
        </label>
      </fieldset>

      <!-- Raw Topics JSON (optional) -->
      <fieldset>
        <legend>Topics JSON (optional)</legend>
        <p class="soft-note">Wird nur benutzt wenn keine Topic‚ÄëZeile (Label) vorhanden ist.</p>
        <label>Topics (JSON)
          <textarea name="topicsJson" rows="8" id="topicsJson"><%= JSON.stringify(cfg.topics || [], null, 2) %></textarea>
        </label>
      </fieldset>

      <!-- Umgebungsvariablen Info -->
      <fieldset>
        <legend>üîß Umgebungsvariablen (.env)</legend>
        <p class="soft-note">Diese Einstellungen m√ºssen direkt in der <code>.env</code> Datei auf dem Server bearbeitet werden:</p>
        <ul class="soft-note" style="margin-top: 0.5rem; line-height: 1.8;">
          <li><code>DISCORD_TOKEN</code> - Bot Token</li>
          <li><code>CLIENT_ID</code> - OAuth2 Client ID</li>
          <li><code>CLIENT_SECRET</code> - OAuth2 Client Secret</li>
          <li><code>PUBLIC_BASE_URL</code> - √ñffentliche URL (z.B. https://trstickets.theredstonee.de)</li>
          <li><code>SESSION_SECRET</code> - Session Secret f√ºr Web-Panel</li>
        </ul>
        <p class="soft-note" style="margin-top: 0.8rem;">‚ö†Ô∏è Aus Sicherheitsgr√ºnden k√∂nnen diese Werte nicht √ºber das Web-Panel ge√§ndert werden.</p>
      </fieldset>

    </div>
    <button type="submit">üíæ <%= t.web.save %></button>
  </form>

  <hr>
  <h2><%= t.web.panel_actions %></h2>
  <div class="actions">
    <form action="/panel/send" method="POST">
      <select name="channelId" required style="min-width: 250px;">
        <option value=""><%= t.web.select_channel %></option>
        <% channels.filter(ch => ch.type === 0).forEach(ch => { %>
          <option value="<%= ch.id %>" <%= cfg.panelChannelId === ch.id ? 'selected' : '' %>>
            # <%= ch.name %>
          </option>
        <% }) %>
      </select>
      <button><i class="fas fa-paper-plane"></i> <%= t.web.send_panel %></button>
    </form>
    <form action="/panel/edit" method="POST">
      <button><i class="fas fa-edit"></i> <%= t.web.edit_panel %></button>
    </form>
    <a href="/tickets" role="button" class="secondary"><i class="fas fa-history"></i> <%= t.web.ticket_history %></a>
  </div>

  <footer>
    <p>TRS Tickets ¬© 2025 Theredstonee ‚Ä¢ Alle Rechte vorbehalten ‚Ä¢ Version <%= version %></p>
    <p class="soft-note">√Ñnderungen speichern sofort in <code>config.json</code></p>
  </footer>

<script>
function delRow(btn){ const tr=btn.closest('tr'); if(tr) tr.remove(); syncFormJson(); syncTopicsPreview(); }
function addTopicRow(){ const tr=document.createElement('tr'); tr.innerHTML=`<td><input name="label" required></td><td><input name="value" placeholder="auto"></td><td><input name="emoji"></td><td><button type="button" class="del-btn" onclick="delRow(this)">‚úñ</button></td>`; document.getElementById('topicRows').appendChild(tr); }
function addFormRow(data={label:'',placeholder:'',type:'short',required:false}){ const tr=document.createElement('tr'); tr.innerHTML=`<td><input name="ffLabel" value="${esc(data.label)}" required></td><td><input name="ffPlaceholder" value="${esc(data.placeholder)}"></td><td><select name="ffType"><option value="short" ${data.type==='short'?'selected':''}>Kurz</option><option value="paragraph" ${data.type==='paragraph'?'selected':''}>Lang</option><option value="number" ${data.type==='number'?'selected':''}>Zahl</option></select></td><td style="text-align:center"><input type="checkbox" name="ffRequired" ${data.required?'checked':''}></td><td><button type="button" class="del-btn" onclick="delRow(this)">‚úñ</button></td>`; document.getElementById('formRows').appendChild(tr); syncFormJson(); }
function esc(s){return String(s).replace(/[&<>"']/g,c=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[c]));}
function syncFormJson(){ const labels=[...document.querySelectorAll('#formRows input[name="ffLabel"]')]; const arr=[]; labels.forEach((inp,idx)=>{ const label=inp.value.trim(); if(!label) return; const placeholder=document.querySelectorAll('#formRows input[name="ffPlaceholder"]')[idx].value.trim(); const type=document.querySelectorAll('#formRows select[name="ffType"]')[idx].value; const required=document.querySelectorAll('#formRows input[name="ffRequired"]')[idx].checked; const obj={label,type}; if(placeholder) obj.placeholder=placeholder; if(required) obj.required=true; arr.push(obj); }); document.getElementById('formFieldsJson').value=JSON.stringify(arr,null,2); }
function syncTopicsPreview(){ const labels=[...document.querySelectorAll('#topicRows input[name="label"]')]; if(!labels.length) return; const arr=[]; labels.forEach((inp,idx)=>{ const L=inp.value.trim(); if(!L) return; const V=document.querySelectorAll('#topicRows input[name="value"]')[idx].value.trim() || L.toLowerCase().replace(/\s+/g,'-'); const E=document.querySelectorAll('#topicRows input[name="emoji"]')[idx].value.trim(); arr.push(E?{label:L,value:V,emoji:E}:{label:L,value:V}); }); document.getElementById('topicsJson').value=JSON.stringify(arr,null,2); }
document.getElementById('formRows').addEventListener('input',syncFormJson);
document.getElementById('topicRows').addEventListener('input',syncTopicsPreview);
// Vor Submit leere Label-Zeilen entfernen
document.getElementById('panelForm').addEventListener('submit',()=>{ [...document.querySelectorAll('#topicRows tr')].forEach(tr=>{ if(!tr.querySelector('input[name="label"]').value.trim()) tr.remove(); }); syncFormJson(); });

// Theme Toggle
function toggleTheme() {
  const html = document.documentElement;
  const currentTheme = html.getAttribute('data-theme');
  const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
  html.setAttribute('data-theme', newTheme);
  localStorage.setItem('trs-theme', newTheme);
  document.getElementById('themeIcon').className = newTheme === 'dark' ? 'fas fa-sun' : 'fas fa-moon';
}

// Theme beim Laden setzen
(function() {
  const savedTheme = localStorage.getItem('trs-theme') || 'light';
  document.documentElement.setAttribute('data-theme', savedTheme);
  document.getElementById('themeIcon').className = savedTheme === 'dark' ? 'fas fa-sun' : 'fas fa-moon';
})();
</script>
</body>
</html>