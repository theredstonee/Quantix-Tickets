<!doctype html>
<html lang="de" data-theme="light">
<head>
  <meta charset="utf-8">
  <title>Ticket‚ÄëBot Panel</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@1/css/pico.min.css">
  <style>
    :root {
      --bg-color: #fff;
      --text-color: #1a1a1a;
      --border-color: #e5e8ec;
      --accent-color: #00b894;
      --accent-hover: #00a077;
      --fieldset-bg: #f8f9fa;
      --thead-bg: #f2f4f8;
      --input-bg: #fff;
      --code-bg: #f0f0f0;
      --success-bg: #d1f2eb;
      --success-border: #2bb780;
      --error-bg: #f8d7da;
      --error-border: #c33;
    }

    [data-theme="dark"] {
      --bg-color: #0a0a0a;
      --text-color: #00ff88;
      --border-color: #1a3a2a;
      --accent-color: #00ff88;
      --accent-hover: #00dd77;
      --fieldset-bg: #0f1510;
      --thead-bg: #0f1f15;
      --input-bg: #0f1510;
      --code-bg: #0a1a0f;
      --success-bg: #0a2015;
      --success-border: #00ff88;
      --error-bg: #2a0a0a;
      --error-border: #ff4444;
    }

    [data-theme="dark"] body {
      background-color: var(--bg-color);
      color: var(--text-color);
    }

    [data-theme="dark"] input,
    [data-theme="dark"] select,
    [data-theme="dark"] textarea {
      background-color: var(--input-bg);
      border-color: var(--border-color);
      color: var(--text-color);
    }

    [data-theme="dark"] fieldset {
      background-color: var(--fieldset-bg);
      border-color: var(--border-color);
    }

    [data-theme="dark"] thead {
      background: var(--thead-bg);
    }

    [data-theme="dark"] code {
      background: var(--code-bg);
      color: var(--accent-color);
    }

    [data-theme="dark"] .good {
      background: var(--success-bg);
      border-color: var(--success-border);
      color: var(--accent-color);
    }

    [data-theme="dark"] .bad {
      background: var(--error-bg);
      border-color: var(--error-border);
      color: #ff6666;
    }

    [data-theme="dark"] a {
      color: var(--accent-color);
    }

    [data-theme="dark"] button:not(.del-btn):not(.theme-toggle) {
      background-color: var(--accent-color);
      color: #000;
    }

    [data-theme="dark"] button:not(.del-btn):not(.theme-toggle):hover {
      background-color: var(--accent-hover);
    }

    body { max-width: 1400px; padding: 0 5rem; line-height: 1.8; }
    table { width:100%; border-collapse:collapse; }
    th,td { padding:.6rem .8rem; }
    table input, table select { width:100%; }
    .grid { display:flex; flex-wrap:wrap; gap:2rem; }
    fieldset { flex:1 1 400px; min-width:370px; padding:2rem; }
    textarea { width:100%; font-family: monospace; resize:vertical; }
    .bad { border:1px solid var(--error-border); padding:1rem 1.5rem; border-radius:6px; background: var(--error-bg); margin:1rem 0; }
    .good { border:1px solid var(--success-border); padding:1rem 1.5rem; border-radius:6px; background: var(--success-bg); margin:1rem 0; }
    .actions form { display:inline-block; margin-right:1rem; }
    footer { margin-top:3rem; font-size:.7rem; opacity:.6; }
    .placeholder-list code { margin-right:.4rem; }
    .add-btn { margin-top:.5rem; }
    .soft-note { font-size:.7rem; opacity:.65; }
    .del-btn { background:#e55353; color:#fff; border:0; padding:.25rem .55rem; border-radius:4px; cursor:pointer; font-size:.7rem; }
    .del-btn:hover { background:#c84242; }
    thead { background: var(--thead-bg); }
    .mini { font-size:.65rem; opacity:.55; }

    .theme-toggle {
      position: fixed;
      top: 1.5rem;
      right: 1.5rem;
      background: var(--accent-color);
      color: #000;
      border: 0;
      width: 3rem;
      height: 3rem;
      border-radius: 50%;
      cursor: pointer;
      font-size: 1.5rem;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s;
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
      z-index: 1000;
    }

    .theme-toggle:hover {
      transform: scale(1.1);
      background: var(--accent-hover);
    }

    [data-theme="dark"] .theme-toggle {
      background: var(--accent-color);
      box-shadow: 0 2px 12px rgba(0,255,136,0.4);
    }

    .header-flex {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
    }

    .server-info {
      font-size: 0.85rem;
      opacity: 0.7;
    }

    [data-theme="dark"] .server-info {
      color: var(--accent-color);
    }

    [data-theme="dark"] select {
      background: var(--accent-color) !important;
      color: #000 !important;
    }
  </style>
</head>
<body class="container">
  <div style="position: fixed; top: 1.5rem; right: 5.5rem; z-index: 1000;">
    <select onchange="window.location.href='/set-language/' + this.value" style="background: var(--accent-color); color: #000; border: 0; padding: 0.75rem; border-radius: 8px; cursor: pointer; font-size: 0.9rem; box-shadow: 0 2px 8px rgba(0,0,0,0.2);">
      <option value="de" <%= lang === 'de' ? 'selected' : '' %>>üá©üá™ Deutsch</option>
      <option value="en" <%= lang === 'en' ? 'selected' : '' %>>üá¨üáß English</option>
      <option value="he" <%= lang === 'he' ? 'selected' : '' %>>üáÆüá± ◊¢◊ë◊®◊ô◊™</option>
    </select>
  </div>
  <button class="theme-toggle" onclick="toggleTheme()" title="Dark Mode umschalten">
    <span id="themeIcon">üåô</span>
  </button>
  <h1>üé´ <%= t.web.title %></h1>

  <% if (msg==='saved')  { %><p class="good"><%= t.web.messages.saved %></p><% } %>
  <% if (msg==='sent')   { %><p class="good"><%= t.web.messages.sent %></p><% } %>
  <% if (msg==='edited') { %><p class="good"><%= t.web.messages.edited %></p><% } %>
  <% if (msg==='nopanel'){ %><p class="bad"><%= t.web.messages.nopanel %></p><% } %>
  <% if (msg==='error')  { %><p class="bad"><%= t.web.messages.error %></p><% } %>

  <form method="POST" autocomplete="off" id="panelForm">
    <div class="grid">

      <!-- Server Einstellungen -->
      <fieldset>
        <legend>‚öôÔ∏è <%= t.web.server_settings %></legend>
        <label><%= t.web.guild_id %>
          <input name="guildId" value="<%= cfg.guildId || guildId || '' %>" placeholder="1234567890123456789" readonly style="background: var(--fieldset-bg); cursor: not-allowed;">
        </label>
        <label><%= t.web.ticket_category %>
          <select name="ticketCategoryId">
            <option value=""><%= t.web.select_category %></option>
            <% channels.filter(ch => ch.type === 4).forEach(ch => { %>
              <option value="<%= ch.id %>" <%= cfg.ticketCategoryId === ch.id ? 'selected' : '' %>>
                üìÅ <%= ch.name %>
              </option>
            <% }) %>
          </select>
        </label>
        <label><%= t.web.log_channel %>
          <select name="logChannelId">
            <option value=""><%= t.web.select_channel %></option>
            <% channels.filter(ch => ch.type === 0).forEach(ch => { %>
              <option value="<%= ch.id %>" <%= cfg.logChannelId === ch.id ? 'selected' : '' %>>
                # <%= ch.name %>
              </option>
            <% }) %>
          </select>
        </label>
        <label><%= t.web.transcript_channel %>
          <select name="transcriptChannelId">
            <option value=""><%= t.web.select_channel %></option>
            <% channels.filter(ch => ch.type === 0).forEach(ch => { %>
              <option value="<%= ch.id %>" <%= cfg.transcriptChannelId === ch.id ? 'selected' : '' %>>
                # <%= ch.name %>
              </option>
            <% }) %>
          </select>
        </label>
        <label><%= t.web.team_role %>
          <select name="teamRoleId">
            <option value=""><%= t.web.select_role %></option>
            <% roles.forEach(role => { %>
              <option value="<%= role.id %>" <%= cfg.teamRoleId === role.id ? 'selected' : '' %>>
                @ <%= role.name %>
              </option>
            <% }) %>
          </select>
        </label>
        <p class="soft-note">Guild ID wird automatisch gesetzt. Team-Rolle bestimmt welche User Zugriff auf Ticket-Funktionen haben.</p>
      </fieldset>

      <!-- Topics -->
      <fieldset>
        <legend><%= t.web.topics %></legend>
        <table>
          <thead>
            <tr><th><%= t.web.topic_label %>*</th><th><%= t.web.topic_value %></th><th><%= t.web.topic_emoji %></th><th><%= t.web.delete %></th></tr>
          </thead>
          <tbody id="topicRows">
            <% (cfg.topics||[]).forEach(topic=>{ %>
              <tr>
                <td><input name="label" value="<%= topic.label %>" required></td>
                <td><input name="value" value="<%= topic.value %>" placeholder="auto"></td>
                <td><input name="emoji" value="<%= topic.emoji||'' %>"></td>
                <td><button type="button" class="del-btn" onclick="delRow(this)">‚úñ</button></td>
              </tr>
            <% }) %>
          </tbody>
        </table>
        <button type="button" class="add-btn" onclick="addTopicRow()">‚ûï Topic</button>
        <p class="soft-note">Ist <b>Value</b> leer, wird es aus dem Label generiert (klein + Bindestriche).</p>
      </fieldset>

      <!-- Ticket Embed -->
      <fieldset>
        <legend><%= t.web.ticket_embed %></legend>
        <p class="placeholder-list soft-note"><%= t.web.placeholders %>: <code>{userMention}</code> <code>{userId}</code> <code>{topicLabel}</code> <code>{topicValue}</code> <code>{ticketNumber}</code></p>
        <label><%= t.web.embed_title %> <input name="embedTitle" value="<%= cfg.ticketEmbed?.title || '' %>"></label>
        <label><%= t.web.embed_description %> <textarea name="embedDescription" rows="7"><%= cfg.ticketEmbed?.description || '' %></textarea></label>
        <label><%= t.web.embed_color %> <input name="embedColor" value="<%= cfg.ticketEmbed?.color || '#2b90d9' %>" placeholder="#2b90d9"></label>
        <label><%= t.web.embed_footer %> <input name="embedFooter" value="<%= cfg.ticketEmbed?.footer || '' %>"></label>
      </fieldset>

      <!-- Panel Embed -->
      <fieldset>
        <legend><%= t.web.panel_embed %></legend>
        <label><%= t.web.embed_title %> <input name="panelTitle" value="<%= cfg.panelEmbed?.title || '' %>"></label>
        <label><%= t.web.embed_description %> <textarea name="panelDescription" rows="6"><%= cfg.panelEmbed?.description || '' %></textarea></label>
        <label><%= t.web.embed_color %> <input name="panelColor" value="<%= cfg.panelEmbed?.color || '#5865F2' %>" placeholder="#5865F2"></label>
        <label><%= t.web.embed_footer %> <input name="panelFooter" value="<%= cfg.panelEmbed?.footer || '' %>"></label>
      </fieldset>

      <!-- Formular Felder -->
      <fieldset>
        <legend>Benutzer‚ÄëFormular Felder</legend>
        <p class="soft-note">Diese Felder MUSS der Nutzer beim Ticket erstellen ausf√ºllen (Modal √∂ffnet sich nach Themenwahl).</p>
        <table>
          <thead>
            <tr><th>Label*</th><th>Placeholder</th><th>Typ</th><th>Required</th><th>L√∂schen</th></tr>
          </thead>
          <tbody id="formRows">
            <% (cfg.formFields||[]).forEach(f=>{ %>
              <tr>
                <td><input name="ffLabel" value="<%= f.label %>" required></td>
                <td><input name="ffPlaceholder" value="<%= f.placeholder||'' %>"></td>
                <td>
                  <select name="ffType">
                    <option value="short" <%= f.type==='short'?'selected':'' %>>Kurz</option>
                    <option value="paragraph" <%= f.type==='paragraph'?'selected':'' %>>Lang</option>
                    <option value="number" <%= f.type==='number'?'selected':'' %>>Zahl</option>
                  </select>
                </td>
                <td style="text-align:center"><input type="checkbox" name="ffRequired" <%= f.required? 'checked':'' %>></td>
                <td><button type="button" class="del-btn" onclick="delRow(this)">‚úñ</button></td>
              </tr>
            <% }) %>
          </tbody>
        </table>
        <button type="button" class="add-btn" onclick="addFormRow()">‚ûï Feld</button>
        <p class="soft-note mini">Typen: <b>short</b> = kurzer Text, <b>paragraph</b> = langer Text, <b>number</b> = numerisch (als Text gespeichert).</p>
        <label class="soft-note">FormFields (JSON Vorschau)
          <textarea id="formFieldsJson" name="formFieldsJson" rows="8"><%= JSON.stringify(cfg.formFields || [], null, 2) %></textarea>
        </label>
      </fieldset>

      <!-- Raw Topics JSON (optional) -->
      <fieldset>
        <legend>Topics JSON (optional)</legend>
        <p class="soft-note">Wird nur benutzt wenn keine Topic‚ÄëZeile (Label) vorhanden ist.</p>
        <label>Topics (JSON)
          <textarea name="topicsJson" rows="8" id="topicsJson"><%= JSON.stringify(cfg.topics || [], null, 2) %></textarea>
        </label>
      </fieldset>

      <!-- Umgebungsvariablen Info -->
      <fieldset>
        <legend>üîß Umgebungsvariablen (.env)</legend>
        <p class="soft-note">Diese Einstellungen m√ºssen direkt in der <code>.env</code> Datei auf dem Server bearbeitet werden:</p>
        <ul class="soft-note" style="margin-top: 0.5rem; line-height: 1.8;">
          <li><code>DISCORD_TOKEN</code> - Bot Token</li>
          <li><code>CLIENT_ID</code> - OAuth2 Client ID</li>
          <li><code>CLIENT_SECRET</code> - OAuth2 Client Secret</li>
          <li><code>PUBLIC_BASE_URL</code> - √ñffentliche URL (z.B. https://trstickets.theredstonee.de)</li>
          <li><code>SESSION_SECRET</code> - Session Secret f√ºr Web-Panel</li>
        </ul>
        <p class="soft-note" style="margin-top: 0.8rem;">‚ö†Ô∏è Aus Sicherheitsgr√ºnden k√∂nnen diese Werte nicht √ºber das Web-Panel ge√§ndert werden.</p>
      </fieldset>

    </div>
    <button type="submit">üíæ <%= t.web.save %></button>
  </form>

  <hr>
  <h2><%= t.web.panel_actions %></h2>
  <div class="actions">
    <form action="/panel/send" method="POST">
      <select name="channelId" required style="min-width: 250px;">
        <option value=""><%= t.web.select_channel %></option>
        <% channels.filter(ch => ch.type === 0).forEach(ch => { %>
          <option value="<%= ch.id %>" <%= cfg.panelChannelId === ch.id ? 'selected' : '' %>>
            # <%= ch.name %>
          </option>
        <% }) %>
      </select>
      <button>üì§ <%= t.web.send_panel %></button>
    </form>
    <form action="/panel/edit" method="POST">
      <button>‚úèÔ∏è <%= t.web.edit_panel %></button>
    </form>
    <a href="/tickets" role="button" class="secondary">üìú <%= t.web.ticket_history %></a>
  </div>

  <footer>
    <p>TRS Tickets ¬©Ô∏è ‚Ä¢ Version <%= version %></p>
    <p class="soft-note">√Ñnderungen speichern sofort in <code>config.json</code></p>
  </footer>

<script>
function delRow(btn){ const tr=btn.closest('tr'); if(tr) tr.remove(); syncFormJson(); syncTopicsPreview(); }
function addTopicRow(){ const tr=document.createElement('tr'); tr.innerHTML=`<td><input name="label" required></td><td><input name="value" placeholder="auto"></td><td><input name="emoji"></td><td><button type="button" class="del-btn" onclick="delRow(this)">‚úñ</button></td>`; document.getElementById('topicRows').appendChild(tr); }
function addFormRow(data={label:'',placeholder:'',type:'short',required:false}){ const tr=document.createElement('tr'); tr.innerHTML=`<td><input name="ffLabel" value="${esc(data.label)}" required></td><td><input name="ffPlaceholder" value="${esc(data.placeholder)}"></td><td><select name="ffType"><option value="short" ${data.type==='short'?'selected':''}>Kurz</option><option value="paragraph" ${data.type==='paragraph'?'selected':''}>Lang</option><option value="number" ${data.type==='number'?'selected':''}>Zahl</option></select></td><td style="text-align:center"><input type="checkbox" name="ffRequired" ${data.required?'checked':''}></td><td><button type="button" class="del-btn" onclick="delRow(this)">‚úñ</button></td>`; document.getElementById('formRows').appendChild(tr); syncFormJson(); }
function esc(s){return String(s).replace(/[&<>"']/g,c=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[c]));}
function syncFormJson(){ const labels=[...document.querySelectorAll('#formRows input[name="ffLabel"]')]; const arr=[]; labels.forEach((inp,idx)=>{ const label=inp.value.trim(); if(!label) return; const placeholder=document.querySelectorAll('#formRows input[name="ffPlaceholder"]')[idx].value.trim(); const type=document.querySelectorAll('#formRows select[name="ffType"]')[idx].value; const required=document.querySelectorAll('#formRows input[name="ffRequired"]')[idx].checked; const obj={label,type}; if(placeholder) obj.placeholder=placeholder; if(required) obj.required=true; arr.push(obj); }); document.getElementById('formFieldsJson').value=JSON.stringify(arr,null,2); }
function syncTopicsPreview(){ const labels=[...document.querySelectorAll('#topicRows input[name="label"]')]; if(!labels.length) return; const arr=[]; labels.forEach((inp,idx)=>{ const L=inp.value.trim(); if(!L) return; const V=document.querySelectorAll('#topicRows input[name="value"]')[idx].value.trim() || L.toLowerCase().replace(/\s+/g,'-'); const E=document.querySelectorAll('#topicRows input[name="emoji"]')[idx].value.trim(); arr.push(E?{label:L,value:V,emoji:E}:{label:L,value:V}); }); document.getElementById('topicsJson').value=JSON.stringify(arr,null,2); }
document.getElementById('formRows').addEventListener('input',syncFormJson);
document.getElementById('topicRows').addEventListener('input',syncTopicsPreview);
// Vor Submit leere Label-Zeilen entfernen
document.getElementById('panelForm').addEventListener('submit',()=>{ [...document.querySelectorAll('#topicRows tr')].forEach(tr=>{ if(!tr.querySelector('input[name="label"]').value.trim()) tr.remove(); }); syncFormJson(); });

// Theme Toggle
function toggleTheme() {
  const html = document.documentElement;
  const currentTheme = html.getAttribute('data-theme');
  const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
  html.setAttribute('data-theme', newTheme);
  localStorage.setItem('trs-theme', newTheme);
  document.getElementById('themeIcon').textContent = newTheme === 'dark' ? '‚òÄÔ∏è' : 'üåô';
}

// Theme beim Laden setzen
(function() {
  const savedTheme = localStorage.getItem('trs-theme') || 'light';
  document.documentElement.setAttribute('data-theme', savedTheme);
  document.getElementById('themeIcon').textContent = savedTheme === 'dark' ? '‚òÄÔ∏è' : 'üåô';
})();
</script>
</body>
</html>