<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8">
  <title>Ticket‚ÄëBot Panel</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@1/css/pico.min.css">
  <style>
    body { max-width: 1200px; }
    table { width:100%; border-collapse:collapse; }
    table th, table td { vertical-align:middle; }
    table input, table select { width:100%; }
    .grid { display:flex; flex-wrap:wrap; gap:1.5rem; }
    fieldset { flex:1 1 360px; min-width:340px; }
    textarea { width:100%; font-family: monospace; resize:vertical; }
    .bad { border:1px solid #c33; padding:.5rem .75rem; }
    .good { border:1px solid #2b7; padding:.5rem .75rem; }
    .actions form { display:inline-block; margin-right:1rem; }
    footer { margin-top:3rem; font-size:.75rem; opacity:.6; }
    .placeholder-list code { margin-right:.4rem; }
    .add-btn { margin-top:.6rem; }
    .soft-note { font-size:.75rem; opacity:.65; }
    .table-wrapper{ max-height:420px; overflow:auto; }
  </style>
</head>
<body class="container">
  <h1>üé´ Ticket‚ÄëBot Panel</h1>

  <% if (msg==='saved')  { %><p class="good">‚úÖ Gespeichert.</p><% } %>
  <% if (msg==='sent')   { %><p class="good">üì§ Panel‚ÄëNachricht gesendet.</p><% } %>
  <% if (msg==='edited') { %><p class="good">‚úèÔ∏è Panel‚ÄëNachricht aktualisiert.</p><% } %>
  <% if (msg==='nopanel'){ %><p class="bad">‚ö†Ô∏è Keine gespeicherte Panel‚ÄëNachricht vorhanden.</p><% } %>
  <% if (msg==='error')  { %><p class="bad">‚ùå Fehler beim Vorgang ‚Äì Konsole pr√ºfen.</p><% } %>

  <form method="POST" autocomplete="off" id="panelForm">
    <div class="grid">

      <!-- Kategorien ------------------------------------------------------------------>
      <fieldset>
        <legend>Kategorien (Topics)</legend>
        <table>
          <thead>
            <tr><th>Label*</th><th>Value</th><th>Emoji</th></tr>
          </thead>
          <tbody id="rows">
            <% (cfg.topics||[]).forEach(t => { %>
              <tr>
                <td><input name="label" value="<%= t.label %>" required></td>
                <td><input name="value" value="<%= t.value %>" placeholder="auto"></td>
                <td><input name="emoji" value="<%= t.emoji || '' %>"></td>
              </tr>
            <% }) %>
          </tbody>
        </table>
        <button type="button" class="add-btn" onclick="addRow()">‚ûï Zeile</button>
        <p class="soft-note">* <b>Label</b> Pflicht. Ist <b>Value</b> leer, wird automatisch aus Label generiert.</p>
      </fieldset>

      <!-- Ticket Embed ----------------------------------------------------------------->
      <fieldset>
        <legend>Ticket Embed Vorlage</legend>
        <p class="placeholder-list soft-note">
          Platzhalter: <code>{userMention}</code> <code>{userId}</code> <code>{topicLabel}</code> <code>{topicValue}</code> <code>{ticketNumber}</code>
        </p>
        <label>Titel
          <input name="embedTitle" value="<%= cfg.ticketEmbed?.title || '' %>">
        </label>
        <label>Beschreibung
          <textarea name="embedDescription" rows="6"><%= cfg.ticketEmbed?.description || '' %></textarea>
        </label>
        <label>Farbe (Hex)
          <input name="embedColor" value="<%= cfg.ticketEmbed?.color || '#2b90d9' %>" placeholder="#2b90d9">
        </label>
        <label>Footer
          <input name="embedFooter" value="<%= cfg.ticketEmbed?.footer || '' %>">
        </label>
      </fieldset>

      <!-- Panel Embed ------------------------------------------------------------------>
      <fieldset>
        <legend>Panel (Dropdown) Embed</legend>
        <label>Panel Titel
          <input name="panelTitle" value="<%= cfg.panelEmbed?.title || '' %>">
        </label>
        <label>Panel Beschreibung
          <textarea name="panelDescription" rows="5"><%= cfg.panelEmbed?.description || '' %></textarea>
        </label>
        <label>Panel Farbe (Hex)
          <input name="panelColor" value="<%= cfg.panelEmbed?.color || '#5865F2' %>" placeholder="#5865F2">
        </label>
        <label>Panel Footer
          <input name="panelFooter" value="<%= cfg.panelEmbed?.footer || '' %>">
        </label>
      </fieldset>

      <!-- Formular Felder ------------------------------------------------------------------>
      <fieldset>
        <legend>Benutzer‚ÄëFormular Felder</legend>
        <div class="table-wrapper">
          <table>
            <thead>
              <tr><th>Label*</th><th>Placeholder</th><th>Typ</th><th>Required</th></tr>
            </thead>
            <tbody id="formRows">
              <% (cfg.formFields||[]).forEach(f => { %>
                <tr>
                  <td><input name="ffLabel" value="<%= f.label %>" required></td>
                  <td><input name="ffPlaceholder" value="<%= f.placeholder || '' %>"></td>
                  <td>
                    <select name="ffType">
                      <option value="short" <%= f.type==='short'? 'selected':'' %>>Kurz</option>
                      <option value="paragraph" <%= f.type==='paragraph'? 'selected':'' %>>Lang</option>
                      <option value="number" <%= f.type==='number'? 'selected':'' %>>Zahl</option>
                    </select>
                  </td>
                  <td style="text-align:center"><input type="checkbox" name="ffRequired" <%= f.required? 'checked':'' %>></td>
                </tr>
              <% }) %>
            </tbody>
          </table>
        </div>
        <button type="button" class="add-btn" onclick="addFormRow()">‚ûï Zeile</button>
        <p class="soft-note">Diese Felder m√ºssen Nutzer beim Ticket‚ÄëErstellen ausf√ºllen (Modal). JSON‚ÄëVorschau wird automatisch aktualisiert.</p>
      </fieldset>

      <!-- RAW JSON ----------------------------------------------------------------------->
      <fieldset>
        <legend>RAW JSON (Optional)</legend>
        <p class="soft-note">JSON wird √ºberschrieben, wenn du oben Tabellenfelder √§nderst.</p>
        <label>Topics (JSON)
          <textarea name="topicsJson" rows="8" id="topicsJson"><%= JSON.stringify(cfg.topics || [], null, 2) %></textarea>
        </label>
        <label>FormFields (JSON)
          <textarea name="formFieldsJson" rows="8" id="formFieldsJson"><%= JSON.stringify(cfg.formFields || [], null, 2) %></textarea>
        </label>
      </fieldset>

    </div>

    <button type="submit">üíæ Speichern</button>
  </form>

  <hr>

  <h2>Panel‚ÄëNachricht Aktionen</h2>
  <div class="actions">
    <form action="/panel/send" method="POST">
      <input name="channelId" placeholder="Channel‚ÄëID" value="<%= cfg.panelChannelId || '' %>" required>
      <button>üì§ Senden</button>
    </form>

    <form action="/panel/edit" method="POST">
      <button>‚úèÔ∏è Bestehende bearbeiten</button>
    </form>
  </div>

  <footer>
    <p>Ticket‚ÄëBot Panel ‚Ä¢ √Ñnderungen werden sofort in <code>config.json</code> gespeichert ‚Ä¢ Stelle sicher, dass der Bot Schreibrechte hat.</p>
  </footer>

<script>
  /* -------------------- Topics -------------------- */
  function addRow(){
    const tr=document.createElement('tr');
    tr.innerHTML=`<td><input name="label" required></td><td><input name="value" placeholder="auto"></td><td><input name="emoji"></td>`;
    document.getElementById('rows').appendChild(tr);
  }

  /* -------------------- FormFields ---------------- */
  function addFormRow(data={label:'',placeholder:'',type:'short',required:false}){
    const tr=document.createElement('tr');
    tr.innerHTML=`<td><input name="ffLabel" value="${escapeHtml(data.label)}" required></td>
      <td><input name="ffPlaceholder" value="${escapeHtml(data.placeholder)}"></td>
      <td><select name="ffType">
            <option value="short" ${data.type==='short'?'selected':''}>Kurz</option>
            <option value="paragraph" ${data.type==='paragraph'?'selected':''}>Lang</option>
            <option value="number" ${data.type==='number'?'selected':''}>Zahl</option>
          </select></td>
      <td style="text-align:center"><input type="checkbox" name="ffRequired" ${data.required?'checked':''}></td>`;
    document.getElementById('formRows').appendChild(tr);
  }

  function escapeHtml(str){ return String(str).replace(/[&<>"']/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[c])); }

  /* Sync JSON preview when form field table changes */
  function syncFormJson(){
    const labels=[...document.querySelectorAll('#formRows input[name="ffLabel"]')];
    if(!labels.length) return; // nothing yet
    const arr=[];
    labels.forEach((inp,idx)=>{
      const label=inp.value.trim(); if(!label) return; // skip empty
      const placeholder=document.querySelectorAll('#formRows input[name="ffPlaceholder"]')[idx].value.trim();
      const type=document.querySelectorAll('#formRows select[name="ffType"]')[idx].value;
      const required=document.querySelectorAll('#formRows input[name="ffRequired"]')[idx].checked;
      const obj={ label, type };
      if(placeholder) obj.placeholder=placeholder;
      if(required) obj.required=true;
      arr.push(obj);
    });
    document.getElementById('formFieldsJson').value=JSON.stringify(arr, null, 2);
  }
  document.getElementById('formRows').addEventListener('input', syncFormJson);
  document.getElementById('panelForm').addEventListener('submit', syncFormJson);
</script>
</body>
</html>
